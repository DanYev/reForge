

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>reforge.martini.martinize_nucleotides &mdash; reForge 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dc75d08a" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            reForge
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../why.html">Why use reForge?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">reForge API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">reForge</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">reforge.martini.martinize_nucleotides</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for reforge.martini.martinize_nucleotides</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.1&quot;</span>
<span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;me and others&quot;</span><span class="p">]</span>

<span class="n">forcefields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;martini30nucleic&quot;</span><span class="p">,</span> <span class="s2">&quot;martini31nucleic&quot;</span><span class="p">]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.resources</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reforge</span><span class="w"> </span><span class="kn">import</span> <span class="n">itpio</span>

<span class="n">rna_system</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>

<span class="c1"># For working versions, the sections are in different modules</span>
<span class="c1">#</span>
<span class="c1"># Index of this file:</span>
<span class="c1">#</span>
<span class="c1">#   1. Options and documentation                             @DOC</span>
<span class="c1">#   2. Description, options and command line parsing         @CMD</span>
<span class="c1">#   3. Helper functions and macros                           @FUNC</span>
<span class="c1">#   4. Finegrained to coarsegrained mapping                  @MAP</span>
<span class="c1">#   5. Secondary structure determination and interpretation  @SS</span>
<span class="c1">#   6. Force field parameters (MARTINI/ELNEDYN)              @FF</span>
<span class="c1">#   7. Elastic network                                       @ELN</span>
<span class="c1">#   8. Structure I/O                                         @IO</span>
<span class="c1">#   9. Topology generation                                   @TOP</span>
<span class="c1">#  10. Main                                                  @MAIN</span>

<span class="c1">###################################</span>
<span class="c1">## 1 # OPTIONS AND DOCUMENTATION ##  -&gt; @DOC &lt;-</span>
<span class="c1">###################################</span>


<span class="c1"># This is a simple and versatily option class that allows easy</span>
<span class="c1"># definition and parsing of options.</span>
<div class="viewcode-block" id="Option">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Option">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Option</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="Option.setvalue">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Option.setvalue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span></div>
</div>



<span class="c1"># Lists for gathering arguments to options that can be specified</span>
<span class="c1"># multiple times on the command line.</span>
<span class="n">lists</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cystines&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;merges&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;multi&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>

<span class="c1"># List of Help text and options.</span>
<span class="c1"># This way we can simply print this list if the user wants help.</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">#   NOTE: Options marked with (+) can be given multiple times on the command line</span>
    <span class="c1">#   option              type number default description</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">========================================================================\n</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Input file (PDB|GRO)&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Output topology (TOP)&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Output coarse grained structure (PDB)&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-seq&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Output list of bead numbers.&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-bmap&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Output index file containing bonded terms.&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Verbose. Be load and noisy.&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Display this help.&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-ss&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Secondary structure (File or string)&quot;</span><span class="p">)),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-ssc&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Cutoff fraction for ss in case of ambiguity (default: 0.5).&quot;</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;-dssp&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DSSP executable for determining structure&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-collagen&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Use collagen parameters&quot;</span><span class="p">)),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-his&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Interactively set the charge of each His-residue.&quot;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;-nt&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Set neutral termini (charged is default)&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-cb&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Set charges at chain breaks (neutral is default)&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-cys&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="n">lists</span><span class="p">[</span><span class="s2">&quot;cystines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Disulphide bond (+)&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-link&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="n">lists</span><span class="p">[</span><span class="s2">&quot;links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Link (+)&quot;</span><span class="p">)),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-merge&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span><span class="n">lists</span><span class="p">[</span><span class="s2">&quot;merges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Merge chains: e.g. -merge A,B,C (+)&quot;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;-name&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Moleculetype name&quot;</span><span class="p">)),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Output position restraints (None/All/Backbone) (default: None)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-pf&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1000</span><span class="p">,</span>
            <span class="s2">&quot;Position restraints force constant (default: 1000 kJ/mol/nm^2)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-ed&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="nb">bool</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;Use dihedrals for extended regions rather than elastic bonds)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;-sep&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Write separate topologies for identical chains.&quot;</span><span class="p">)),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-ff&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;martini30nucleic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Which forcefield to use: &quot;</span> <span class="o">+</span> <span class="s2">&quot; ,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">forcefields</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;-elastic&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Write elastic bonds&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-ef&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Elastic bond force constant Fc&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-el&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Elastic bond lower cutoff: F = Fc if rij &lt; lo&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-eu&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s2">&quot;Elastic bond upper cutoff: F = 0  if rij &gt; up&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-ea&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Elastic bond decay factor a&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;-ep&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Elastic bond decay power p&quot;</span><span class="p">)),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-em&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Remove elastic bonds with force constant lower than this&quot;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-eb&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="s2">&quot;Comma separated list of bead names for elastic bonds&quot;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-type&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Type of DNA/RNA topology (ss/ds-stiff/ds-soft) to create. (default: ss)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;-multi&quot;</span><span class="p">,</span>
        <span class="n">Option</span><span class="p">(</span>
            <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;multi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Chain to be set up for multiscaling (+)&quot;</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;-sys&quot;</span><span class="p">,</span> <span class="n">Option</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;1RNA&quot;</span><span class="p">,</span> <span class="s2">&quot;AA SYS&quot;</span><span class="p">)),</span>
<span class="p">]</span>

<span class="c1">## Martini Quotes</span>
<span class="n">martiniq</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span>
        <span class="s2">&quot;Robert Benchley&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Why don&#39;t you get out of that wet coat and into a dry martini?&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;James Thurber&quot;</span><span class="p">,</span> <span class="s2">&quot;One martini is all right, two is two many, three is not enough&quot;</span><span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;Philip Larkin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The chromatic scale is what you use to give the effect of drinking a quinine martini and having an enema simultaneously.&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;William Emerson, Jr.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;And when that first martini hits the liver like a silver bullet, there is a sigh of contentment that can be heard in Dubuque.&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;Alec Waugh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I am prepared to believe that a dry martini slightly impairs the palate, but think what it does for the soul.&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;Gerald R. Ford&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The three-martini lunch is the epitome of American efficiency. Where else can you get an earful, a bellyful and a snootful at the same time?&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;P. G. Wodehouse&quot;</span><span class="p">,</span> <span class="s2">&quot;He was white and shaken, like a dry martini.&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1">## DNA elastic network list</span>
<span class="n">enStrandLengths</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>


<div class="viewcode-block" id="help">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.help">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">help</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print help text and list of options and end the program.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
    <span class="nb">print</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>



<span class="c1">##############################</span>
<span class="c1">## 2 # COMMAND LINE PARSING ##  -&gt; @CMD &lt;-</span>
<span class="c1">##############################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">logging</span>


<span class="c1"># Helper function to parse atom strings given on the command line:</span>
<span class="c1">#   resid</span>
<span class="c1">#   resname/resid</span>
<span class="c1">#   chain/resname/resid</span>
<span class="c1">#   resname/resid/atom</span>
<span class="c1">#   chain/resname/resid/atom</span>
<span class="c1">#   chain//resid</span>
<span class="c1">#   chain/resname/atom</span>
<div class="viewcode-block" id="str2atom">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.str2atom">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">str2atom</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Only a residue number:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Residue name and number (CYS/123):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>  <span class="c1"># Chain, residue name, residue number</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Residue name, residue number, atom name</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="option_parser">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.option_parser">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">option_parser</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">lists</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1"># Check whether there is a request for help</span>
    <span class="k">if</span> <span class="s2">&quot;-h&quot;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="s2">&quot;--help&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">help</span><span class="p">()</span>

    <span class="c1"># Convert the option list to a dictionary, discarding all comments</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">])</span>

    <span class="c1"># This information we would like to print to some files, so let&#39;s put it in our information class</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;Arguments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:]</span>

    <span class="k">while</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="n">ar</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">ar</span><span class="p">]</span><span class="o">.</span><span class="n">num</span><span class="p">)])</span>

    <span class="c1">## LOGGING ##</span>
    <span class="c1"># Set the log level and communicate which options are set and what is happening</span>
    <span class="c1"># If &#39;Verbose&#39; is set, change the logger level</span>
    <span class="n">logLevel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-v&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)-7s</span><span class="s2">    </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MARTINIZE, script version </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>
    <span class="c1"># logging.info(&#39;If you use this script please cite:&#39;)</span>
    <span class="c1"># logging.info(&#39;de Jong et al., J. Chem. Theory Comput., 2013, DOI:10.1021/ct300646g&#39;)</span>

    <span class="c1"># Write options based on selected topology type. @net</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ss&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;martini30nucleic&quot;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ds&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;martini30nucleic&quot;</span><span class="p">])</span>
        <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;merges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;A, B&quot;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-eu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;1.8&quot;</span><span class="p">])</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ef&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;200&quot;</span><span class="p">])</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-eb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;BB1&quot;</span><span class="p">,</span> <span class="s2">&quot;BB3&quot;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pol&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;martini31nucleic&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Undefined topology type. Giving up...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-eb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setvalue</span><span class="p">([</span><span class="s2">&quot;BB2&quot;</span><span class="p">])</span>

    <span class="c1"># The make the program flexible, the forcefield parameters are defined</span>
    <span class="c1"># for multiple forcefield. Check if a existing one is defined:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to load the forcefield class from a different file</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_tmp</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">())()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Try to load the forcefield class from the current file</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()]()</span>

    <span class="c1"># Process the raw options from the command line</span>
    <span class="c1"># Boolean options are set to more intuitive variables</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;Collagen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-collagen&quot;</span><span class="p">]</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;chHIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-his&quot;</span><span class="p">]</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ChargesAtBreaks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-cb&quot;</span><span class="p">]</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;NeutralTermini&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-nt&quot;</span><span class="p">]</span>
    <span class="c1"># options[&#39;ExtendedDihedrals&#39;]   = options[&#39;-ed&#39;]</span>
    <span class="c1"># options[&#39;RetainHETATM&#39;]        = False # options[&#39;-hetatm&#39;]</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;SeparateTop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-sep&quot;</span><span class="p">]</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;MixedChains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># options[&#39;-mixed&#39;]</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticNetwork&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-elastic&quot;</span><span class="p">]</span>

    <span class="c1"># Parsing of some other options into variables</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMaximumForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ef&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMinimumForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-em&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticLowerBound&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-el&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticUpperBound&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-eu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticDecayFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ea&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticDecayPower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ep&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticBeads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-eb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosResForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-pf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="s2">&quot;none&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;backbone&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BB&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ElasticNetwork</span><span class="p">:</span>
        <span class="c1"># Some forcefields, like elnedyn, always use an elatic network. This is set in the</span>
        <span class="c1"># forcefield file, with the parameter ElasticNetwork.</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticNetwork&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Merges, links and cystines</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;mergeList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;merges&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;merges&quot;</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="c1"># Process links</span>
    <span class="n">linkList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">linkListCG</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;links&quot;</span><span class="p">]:</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">str2atom</span><span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">str2atom</span><span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Bond with given length and force constant</span>
            <span class="n">bl</span><span class="p">,</span> <span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Constraint at given distance</span>
            <span class="n">bl</span><span class="p">,</span> <span class="n">fc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Constraint at distance in structure</span>
            <span class="n">bl</span><span class="p">,</span> <span class="n">fc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="c1"># Store the link, but do not list the atom name in the</span>
        <span class="c1"># atomistic link list. Otherwise it will not get noticed</span>
        <span class="c1"># as a valid link when checking for merging chains</span>
        <span class="n">linkList</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span>
        <span class="n">linkListCG</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">fc</span><span class="p">))</span>

    <span class="c1"># Cystines -- This should be done for all special bonds listed in the _special_ dictionary</span>
    <span class="n">CystineCheckBonds</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># By default, do not detect cystine bridges</span>
    <span class="n">CystineMaxDist2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mf">0.22</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Maximum distance (A) for detection of SS bonds</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;cystines&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">CystineCheckBonds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">CystineCheckBonds</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">CystineMaxDist2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This item should be a pair of cysteines</span>
            <span class="n">cysA</span><span class="p">,</span> <span class="n">cysB</span> <span class="o">=</span> <span class="p">[</span><span class="n">str2atom</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="c1"># Internally we handle the residue number shifted by ord(&#39; &#39;)&lt;&lt;20. We have to add this to the</span>
            <span class="c1"># cys-residue numbers given here as well.</span>
            <span class="n">constant</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span>
            <span class="n">linkList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;SG&quot;</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="n">cysA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">constant</span><span class="p">,</span> <span class="n">cysA</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;SG&quot;</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="n">cysB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">constant</span><span class="p">,</span> <span class="n">cysB</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">linkListCG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;SC1&quot;</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="n">cysA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">constant</span><span class="p">,</span> <span class="n">cysA</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;SC1&quot;</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="n">cysB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">constant</span><span class="p">,</span> <span class="n">cysB</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Now we have done everything to it, we can add Link/cystine related stuff to options</span>
    <span class="c1"># &#39;multi&#39; is not stored anywhere else, so that we also add</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;linkList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linkList</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;linkListCG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linkListCG</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;CystineCheckBonds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CystineCheckBonds</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;CystineMaxDist2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CystineMaxDist2</span>
    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;multi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lists</span><span class="p">[</span><span class="s2">&quot;multi&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;ForceField&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The </span><span class="si">%s</span><span class="s2"> forcefield will be used.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Forcefield &#39;</span><span class="si">%s</span><span class="s2">&#39; has not been implemented.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ff&quot;</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Position restraints will be generated.&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Position restraints are only enabled if -DPOSRES is set in the MDP file&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">options</span></div>



<span class="c1">#################################################</span>
<span class="c1">## 3 # HELPER FUNCTIONS, CLASSES AND SHORTCUTS ##  -&gt; @FUNC &lt;-</span>
<span class="c1">#################################################</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="c1"># ----+------------------+</span>
<span class="c1">## A | STRING FUNCTIONS |</span>
<span class="c1"># ----+------------------+</span>


<span class="c1"># Split a string</span>
<div class="viewcode-block" id="spl">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.spl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spl</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span></div>



<span class="c1"># Split each argument in a list</span>
<div class="viewcode-block" id="nsplit">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.nsplit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nsplit</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span></div>



<span class="c1"># Make a dictionary from two lists</span>
<div class="viewcode-block" id="hash">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.hash">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>



<span class="c1"># Function to reformat pattern strings</span>
<div class="viewcode-block" id="pat">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span></div>



<span class="c1"># Function to generate formatted strings according to the argument type</span>
<div class="viewcode-block" id="formatString">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.formatString">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">formatString</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">i</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%5d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%2.1e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%8.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>



<span class="c1"># ----+----------------+</span>
<span class="c1">## B | MATH FUNCTIONS |</span>
<span class="c1"># ----+----------------+</span>


<div class="viewcode-block" id="cos_angle">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.cos_angle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cos_angle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)])</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">([</span><span class="n">j</span> <span class="o">*</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">/</span> <span class="n">q</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="norm2">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.norm2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">norm2</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span></div>



<div class="viewcode-block" id="norm">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.norm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">norm</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm2</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></div>



<div class="viewcode-block" id="distance2">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.distance2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">distance2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span></div>



<span class="c1">##########################</span>
<span class="c1">## 4 # FG -&gt; CG MAPPING ##  -&gt; @MAP &lt;-</span>
<span class="c1">##########################</span>


<span class="n">dnares3</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="s2">&quot;DT&quot;</span><span class="p">]</span>
<span class="n">dnares1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dA&quot;</span><span class="p">,</span> <span class="s2">&quot;dC&quot;</span><span class="p">,</span> <span class="s2">&quot;dG&quot;</span><span class="p">,</span> <span class="s2">&quot;dT&quot;</span><span class="p">]</span>
<span class="n">rnares3</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">]</span>
<span class="n">rnares1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">]</span>  <span class="c1">#</span>

<span class="c1"># Residue classes:</span>
<span class="n">nucleic</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span>
    <span class="s2">&quot;DA DC DG DT A C G U </span><span class="se">\</span>
<span class="s2">    RA3 RA5 RC3 RC5 RG3 RG5 RU3 RU5 </span><span class="se">\</span>
<span class="s2">    DMA DHU MRA MRC MRG MRU NMC PSU SPA RAP </span><span class="se">\</span>
<span class="s2">    1MG 2MA 2MG 3MP 3MU 4SU 5MC 5MG 5MU 6MA 7MG&quot;</span>
<span class="p">)</span>

<span class="n">rnares3</span> <span class="o">=</span> <span class="n">nucleic</span>
<span class="n">rnares1</span> <span class="o">=</span> <span class="n">nucleic</span>

<span class="c1"># Amino acid nucleic acid codes:</span>
<span class="c1"># The naming (AA and &#39;3&#39;) is not strictly correct when adding DNA/RNA, but we keep it like this for consistincy.</span>
<span class="n">AA3</span> <span class="o">=</span> <span class="n">dnares3</span> <span class="o">+</span> <span class="n">rnares3</span>  <span class="c1"># @#</span>
<span class="n">AA1</span> <span class="o">=</span> <span class="n">dnares1</span> <span class="o">+</span> <span class="n">rnares1</span>  <span class="c1"># @#</span>

<span class="c1"># Dictionaries for conversion from one letter code to three letter code v.v.</span>
<span class="n">AA123</span><span class="p">,</span> <span class="n">AA321</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">AA1</span><span class="p">,</span> <span class="n">AA3</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">AA3</span><span class="p">,</span> <span class="n">AA1</span><span class="p">)</span>

<span class="n">residueTypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Nucleic&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nucleic</span><span class="p">])</span>


<div class="viewcode-block" id="CoarseGrained">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.CoarseGrained">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CoarseGrained</span><span class="p">:</span>
    <span class="c1"># Class for mapping an atomistic residue list to a coarsegrained one</span>
    <span class="c1"># Should get an __init__ function taking a residuelist, atomlist, Pymol selection or ChemPy model</span>
    <span class="c1"># The result should be stored in a list-type attribute</span>
    <span class="c1"># The class should have pdbstr and grostr methods</span>

    <span class="c1"># Standard mapping groups</span>
    <span class="n">dna_bb</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;P OP1 OP2 O5&#39; O3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&#39; O4&#39; C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&#39; C2&#39; C1&#39;&quot;</span><span class="p">)</span>
    <span class="n">rna_bb</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;P OP1 OP2 O5&#39; O3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&#39; O4&#39; C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&#39; C2&#39; O2&#39; C1&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Generic names for DNA and RNA beads</span>
    <span class="n">residue_bead_names_dna</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;BB1 BB2 BB3 SC1 SC2 SC3 SC4 SC5 SC6 SC7 SC8&quot;</span><span class="p">)</span>
    <span class="n">residue_bead_names_rna</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;BB1 BB2 BB3 SC1 SC2 SC3 SC4 SC5 SC6 SC7 SC8&quot;</span><span class="p">)</span>

    <span class="c1"># This dictionary contains the bead names for all residues,</span>
    <span class="c1"># following the order in &#39;mapping&#39;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Add the default bead names for all DNA/RNA nucleic acids</span>
    <span class="n">names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s2">&quot;BB1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;BB2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;BB3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC5&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC6&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC7&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC8&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nucleic</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Crude mass for weighted average. No consideration of united atoms.</span>
    <span class="c1"># This will probably give only minor deviations, while also giving less headache</span>
    <span class="c1"># mass = {&#39;H&#39;: 1,&#39;C&#39;: 12,&#39;N&#39;: 14,&#39;O&#39;: 16,&#39;S&#39;: 32,&#39;P&#39;: 31,&#39;M&#39;: 0}</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span></div>



<span class="c1"># Determine average position for a set of weights and coordinates</span>
<span class="c1"># This is a rather specific function that requires a list of items</span>
<span class="c1"># [(m,(x,y,z),id),..] and returns the weighted average of the</span>
<span class="c1"># coordinates and the list of ids mapped to this bead</span>
<div class="viewcode-block" id="aver">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.aver">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">aver</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="c1"># print(b)</span>
    <span class="n">mwx</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[((</span><span class="n">m</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">z</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># Weighted coordinates</span>
    <span class="c1"># tm  = sum(zip(*b)[0])</span>
    <span class="n">total_mass</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># Sum of weights</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_mass</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">mwx</span><span class="p">)],</span> <span class="n">ids</span>  <span class="c1"># Centre of mass</span></div>



<span class="c1"># Return the CG beads for an atomistic residue, using the mapping specified above</span>
<span class="c1"># The residue &#39;r&#39; is simply a list of atoms, and each atom is a list:</span>
<span class="c1"># [ name, resname, resid, chain, x, y, z ]</span>
<div class="viewcode-block" id="map">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ff - chosen force field for the mapping</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># Mapping for this residue</span>
    <span class="c1"># Get the name, mass and coordinates for all atoms in the residue</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CoarseGrained</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
    <span class="c1"># Store weight, coordinate and index for atoms that match a bead</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">coord</span><span class="p">)))</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span>
    <span class="p">]</span>
    <span class="c1"># Bead positions</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">aver</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">q</span><span class="p">])</span></div>



<span class="c1"># Mapping for index file</span>
<div class="viewcode-block" id="mapIndex">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.mapIndex">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mapIndex</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># Mapping for this residue</span>
    <span class="c1"># Get the name, mass and coordinates for all atoms in the residue</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CoarseGrained</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
    <span class="c1"># Store weight, coordinate and index for atoms that match a bead</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">coord</span><span class="p">)))</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span>
    <span class="p">]</span></div>



<span class="c1">#############################</span>
<span class="c1">## 5 # SECONDARY STRUCTURE ##  -&gt; @SS &lt;-</span>
<span class="c1">#############################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">subp</span>

<span class="c1"># ----+--------------------------------------+</span>
<span class="c1">## A | SECONDARY STRUCTURE TYPE DEFINITIONS |</span>
<span class="c1"># ----+--------------------------------------+</span>


<span class="n">bbss</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;  F     E     H     1     2     3     T     S     C&quot;</span><span class="p">)</span>  <span class="c1"># SS one letter</span>


<span class="c1"># The following dictionary contains secondary structure types as assigned by</span>
<span class="c1"># different programs. The corresponding Martini secondary structure types are</span>
<span class="c1"># listed in cgss</span>
<span class="c1">#</span>
<span class="c1"># NOTE:</span>
<span class="c1">#  Each list of letters in the dictionary ss should exactly match the list</span>
<span class="c1">#  in cgss.</span>
<span class="c1">#</span>
<span class="n">ssdefs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dssp&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;.HGIBETSC~&quot;</span><span class="p">),</span>  <span class="c1"># DSSP one letter secondary structure code     #@#</span>
    <span class="s2">&quot;pymol&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;.H...S...L&quot;</span><span class="p">),</span>  <span class="c1"># Pymol one letter secondary structure code    #@#</span>
    <span class="s2">&quot;gmx&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;.H...ETS.C&quot;</span><span class="p">),</span>  <span class="c1"># Gromacs secondary structure dump code        #@#</span>
    <span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;FHHHEETSCC&quot;</span><span class="p">),</span>  <span class="c1"># Internal CG secondary structure codes        #@#</span>
<span class="p">}</span>
<span class="n">cgss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;FHHHEETSCC&quot;</span><span class="p">)</span>  <span class="c1"># Corresponding CG secondary structure types   #@#</span>


<span class="c1"># ----+-------------------------------------------+</span>
<span class="c1">## B | SECONDARY STRUCTURE PATTERN SUBSTITUTIONS |</span>
<span class="c1"># ----+-------------------------------------------+</span>


<span class="c1"># For all structure types specific dihedrals may be used if four or</span>
<span class="c1"># more consecutive residues are assigned that type.</span>

<span class="c1"># Helix start and end regions are special and require assignment of</span>
<span class="c1"># specific types. The following pattern substitutions are applied</span>
<span class="c1"># (in the given order). A dot matches any other type.</span>
<span class="c1"># Patterns can be added to the dictionaries. This only makes sense</span>
<span class="c1"># if for each key in patterns there is a matching key in pattypes.</span>
<span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">pat</span><span class="p">(</span><span class="s2">&quot;.H. .HH. .HHH. .HHHH. .HHHHH. .HHHHHH. .HHHHHHH. .HHHH HHHH.&quot;</span><span class="p">)</span>  <span class="c1"># @#</span>
<span class="p">}</span>
<span class="n">pattypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">pat</span><span class="p">(</span><span class="s2">&quot;.3. .33. .333. .3333. .13332. .113322. .1113222. .1111 2222.&quot;</span><span class="p">)</span>  <span class="c1"># @#</span>
<span class="p">}</span>


<span class="c1"># ----+----------+</span>
<span class="c1">## C | INTERNAL |</span>
<span class="c1"># ----+----------+</span>


<span class="c1"># Pymol Colors</span>
<span class="c1">#           F   E   H   1   2   3   T   S   C</span>
<span class="n">ssnum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># @#</span>

<span class="c1"># Dictionary returning a number for a given type of secondary structure</span>
<span class="c1"># This can be used for setting the b-factor field for coloring</span>
<span class="n">ss2num</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">bbss</span><span class="p">,</span> <span class="n">ssnum</span><span class="p">)</span>


<span class="c1"># List of programs for which secondary structure definitions can be processed</span>
<span class="n">programs</span> <span class="o">=</span> <span class="n">ssdefs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="c1"># Dictionaries mapping ss types to the CG ss types</span>
<span class="n">ssd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">ssdefs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cgss</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">programs</span><span class="p">])</span>


<span class="c1"># From the secondary structure dictionaries we create translation tables</span>
<span class="c1"># with which all secondary structure types can be processed. Anything</span>
<span class="c1"># not listed above will be mapped to C (coil).</span>
<span class="c1"># Note, a translation table is a list of 256 characters to map standard</span>
<span class="c1"># ascii characters to.</span>
<div class="viewcode-block" id="tt">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.tt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tt</span><span class="p">(</span><span class="n">program</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ssd</span><span class="p">[</span><span class="n">program</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)])</span></div>



<span class="c1"># The translation table depends on the program used to obtain the</span>
<span class="c1"># secondary structure definitions</span>
<span class="n">sstt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">programs</span><span class="p">])</span>


<span class="c1"># The following translation tables are used to identify stretches of</span>
<span class="c1"># a certain type of secondary structure. These translation tables have</span>
<span class="c1"># every character, except for the indicated secondary structure, set to</span>
<span class="c1"># \x00. This allows summing the sequences after processing to obtain</span>
<span class="c1"># a single sequence summarizing all the features.</span>
<span class="n">null</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span>
<span class="n">sstd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">null</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">null</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cgss</span><span class="p">])</span>


<span class="c1"># Pattern substitutions</span>
<div class="viewcode-block" id="typesub">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.typesub">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">typesub</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">null</span> <span class="o">+</span> <span class="n">seq</span> <span class="o">+</span> <span class="n">null</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>



<span class="c1"># The following function translates a string encoding the secondary structure</span>
<span class="c1"># to a string of corresponding Martini types, taking the origin of the</span>
<span class="c1"># secondary structure into account, and replacing termini if requested.</span>
<div class="viewcode-block" id="ssClassification">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ssClassification">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ssClassification</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="s2">&quot;self&quot;</span><span class="p">):</span>
    <span class="c1"># Translate dssp/pymol/gmx ss to Martini ss</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">sstt</span><span class="p">[</span><span class="n">program</span><span class="p">])</span>
    <span class="c1"># Separate the different secondary structure types</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">sstd</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sstd</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="c1"># Do type substitutions based on patterns</span>
    <span class="c1"># If the ss type is not in the patterns lists, do not substitute</span>
    <span class="c1"># (use empty lists for substitutions)</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">typesub</span><span class="p">(</span><span class="n">sep</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">pattypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sstd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="c1"># Translate all types to numerical values</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">ord</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">typ</span><span class="p">]</span>
    <span class="c1"># Sum characters back to get a full typed sequence</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">typ</span><span class="p">)])</span>
    <span class="c1"># Return both the actual as well as the fully typed sequence</span>
    <span class="k">return</span> <span class="n">ss</span><span class="p">,</span> <span class="n">typ</span></div>



<span class="c1">###################################</span>
<span class="c1">## 5 # FORCE FIELDS ##  -&gt; @FF &lt;-</span>
<span class="c1">###################################</span>


<div class="viewcode-block" id="ForceField">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ForceField</span><span class="p">:</span>

<div class="viewcode-block" id="ForceField.read_itp">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.read_itp">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_itp</span><span class="p">(</span><span class="n">itp_file</span><span class="p">):</span>
        <span class="n">itp_data</span> <span class="o">=</span> <span class="n">itpio</span><span class="o">.</span><span class="n">read_itp</span><span class="p">(</span><span class="n">itp_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">itp_data</span></div>


<div class="viewcode-block" id="ForceField.read_itps">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.read_itps">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_itps</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="c1"># itpdir = os.path.abspath(f&#39;/scratch/dyangali/reforge/reforge/itp/{directory}&#39;)</span>
        <span class="n">itpdir</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;reforge&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;martini&quot;</span> <span class="o">/</span> <span class="s2">&quot;itp&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">itpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_A_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">.itp&quot;</span><span class="p">)</span>
        <span class="n">a_itp_data</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">read_itp</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">itpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_C_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">.itp&quot;</span><span class="p">)</span>
        <span class="n">c_itp_data</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">read_itp</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">itpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_G_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">.itp&quot;</span><span class="p">)</span>
        <span class="n">g_itp_data</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">read_itp</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">itpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_U_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">.itp&quot;</span><span class="p">)</span>
        <span class="n">u_itp_data</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">read_itp</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a_itp_data</span><span class="p">,</span> <span class="n">c_itp_data</span><span class="p">,</span> <span class="n">g_itp_data</span><span class="p">,</span> <span class="n">u_itp_data</span></div>


<div class="viewcode-block" id="ForceField.itp_to_indata">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.itp_to_indata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">itp_to_indata</span><span class="p">(</span><span class="n">itp_data</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;bonds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;angles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;impropers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;virtual_sites3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exclusions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pairs&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">connectivity</span> <span class="o">=</span> <span class="p">[</span><span class="n">itp_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">itp_data</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">itp_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">itp_data</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">parameters</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># By default use an elastic network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ElasticNetwork</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Elastic networks bond shouldn&#39;t lead to exclusions (type 6)</span>
        <span class="c1"># But Elnedyn has been parametrized with type 1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EBondType</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="c1">## DNA DICTIONARIES ##</span>
        <span class="c1"># Dictionary for the connectivities and parameters of bonds between DNA backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbBondDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span><span class="p">[</span><span class="s2">&quot;bond&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span><span class="p">[</span><span class="s2">&quot;bond&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for the connectivities and parameters of angles between DNA backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbAngleDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for the connectivities and parameters of dihedrals between DNA backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbDihDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span><span class="p">[</span><span class="s2">&quot;dih&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span><span class="p">[</span><span class="s2">&quot;dih&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for exclusions for DNA backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbExclDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for pairs for DNA backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbPairDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">]))</span>

        <span class="c1">## RNA DICTIONARIES ##</span>
        <span class="c1"># Dictionary for the connectivities and parameters of bonds between rna backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbBondDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span><span class="p">[</span><span class="s2">&quot;bond&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span><span class="p">[</span><span class="s2">&quot;bond&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for the connectivities and parameters of angles between rna backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbAngleDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for the connectivities and parameters of dihedrals between rna backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbDihDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span><span class="p">[</span><span class="s2">&quot;dih&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span><span class="p">[</span><span class="s2">&quot;dih&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for exclusions for rna backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbExclDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]))</span>
        <span class="c1"># Dictionary for pairs for rna backbone beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbPairDictC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">]))</span>

    <span class="c1"># The following function returns the backbone bead for a given residue and</span>
    <span class="c1"># secondary structure type.</span>
    <span class="c1"># 1. Check if the residue is DNA/RNA and return the whole backbone for those</span>
    <span class="c1"># 2. Look up the proper dictionary for the residue</span>
    <span class="c1"># 3. Get the proper type from it for the secondary structure</span>
    <span class="c1"># If the residue is not in the dictionary of specials, use the default</span>
    <span class="c1"># If the secondary structure is not listed (in the residue specific</span>
    <span class="c1"># dictionary) revert to the default.</span>

<div class="viewcode-block" id="ForceField.bbGetBead">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.bbGetBead">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbGetBead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">ss</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">dnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span><span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">rnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span><span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;This script supports only DNA or RNA.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ForceField.bbGetBond">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.bbGetBond">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbGetBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">):</span>
        <span class="c1"># Retrieve parameters for each residue from tables defined above</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbBondDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbBondDictC</span><span class="p">[</span><span class="n">ca</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbBondDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbBondDictC</span><span class="p">[</span><span class="n">ca</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;This script supports only DNA or RNA.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ForceField.bbGetAngle">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.bbGetAngle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbGetAngle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbAngleDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbAngleDictC</span><span class="p">[</span><span class="n">ca</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbAngleDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbAngleDictC</span><span class="p">[</span><span class="n">ca</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;This script supports only DNA or RNA.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ForceField.bbGetExclusion">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.bbGetExclusion">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbGetExclusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbExclDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbExclDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;This script supports only DNA or RNA.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ForceField.bbGetPair">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.bbGetPair">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbGetPair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbPairDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbPairDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;This script supports only DNA or RNA.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ForceField.bbGetDihedral">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.bbGetDihedral">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bbGetDihedral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">):</span>
        <span class="c1"># Retrieve parameters for each residue from table defined above</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbDihDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dnaBbDihDictC</span><span class="p">[</span><span class="n">ca</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rnares3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbDihDictC</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnaBbDihDictC</span><span class="p">[</span><span class="n">ca</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;This script supports only DNA or RNA.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ForceField.getCharge">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.getCharge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">aname</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">charges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbcharges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>


<div class="viewcode-block" id="ForceField.messages">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.messages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints any force-field specific logging messages.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="k">pass</span></div>


<div class="viewcode-block" id="ForceField.update_adenine">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.update_adenine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_adenine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RA3&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RA3&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RA5&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RA5&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;2MA&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;2MA&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;DMA&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;DMA&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;SPA&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;SPA&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RAP&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RAP&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;6MA&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;6MA&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span></div>


<div class="viewcode-block" id="ForceField.update_cytosine">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.update_cytosine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_cytosine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RC3&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RC3&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RC5&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RC5&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;MRC&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;MRC&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;5MC&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;5MC&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;NMC&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;NMC&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span></div>


<div class="viewcode-block" id="ForceField.update_guanine">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.update_guanine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_guanine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RG3&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RG3&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RG5&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RG5&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;MRG&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;MRG&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;1MG&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;1MG&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;2MG&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;2MG&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;7MG&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;7MG&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span></div>


<div class="viewcode-block" id="ForceField.update_uracil">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.update_uracil">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_uracil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RU3&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RU3&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RU5&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RU5&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;MRU&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;MRU&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;DHU&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;DHU&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;PSU&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;PSU&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;3MP&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;3MP&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;3MU&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;3MU&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;4SU&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;4SU&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;5MU&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;5MU&quot;</span><span class="p">:</span> <span class="n">connectivity</span><span class="p">})</span></div>


<div class="viewcode-block" id="ForceField.update_non_standard_mapping">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.ForceField.update_non_standard_mapping">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_non_standard_mapping</span><span class="p">(</span><span class="n">mapping</span><span class="p">):</span>
        <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;RA3&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RA5&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;2MA&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;6MA&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RAP&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;DMA&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;DHA&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;SPA&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RC3&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RC5&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="s2">&quot;5MC&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="s2">&quot;3MP&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="s2">&quot;MRC&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="s2">&quot;NMC&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RG3&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RG5&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">],</span>
                <span class="s2">&quot;1MG&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">],</span>
                <span class="s2">&quot;2MG&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">],</span>
                <span class="s2">&quot;7MG&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">],</span>
                <span class="s2">&quot;MRG&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RU3&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;RU5&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;4SU&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;DHU&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;PSU&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;5MU&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;3MU&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;3MP&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
                <span class="s2">&quot;MRU&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="martini30nucleic">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.martini30nucleic">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">martini30nucleic</span><span class="p">(</span><span class="n">ForceField</span><span class="p">):</span>

    <span class="c1"># FF mapping</span>
    <span class="n">bb_mapping</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">(</span>
        <span class="s2">&quot;P OP1 OP2 O5&#39; O3&#39; O1P O2P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C5&#39; 1H5&#39; 2H5&#39; H5&#39; H5&#39;&#39; C4&#39; H4&#39; O4&#39; C3&#39; H3&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C1&#39; C2&#39; O2&#39; O4&#39;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span>
        <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;N9 C8 H8&quot;</span><span class="p">,</span> <span class="s2">&quot;N3 C4&quot;</span><span class="p">,</span> <span class="s2">&quot;N1 C2 H2&quot;</span><span class="p">,</span> <span class="s2">&quot;N6 C6 H61 H62&quot;</span><span class="p">,</span> <span class="s2">&quot;N7 C5&quot;</span><span class="p">),</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span> <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;N1 C5 C6&quot;</span><span class="p">,</span> <span class="s2">&quot;C2 O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N4 C4 H41 H42&quot;</span><span class="p">),</span>
        <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span>
        <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;C8 H8 N9&quot;</span><span class="p">,</span> <span class="s2">&quot;C4 N3&quot;</span><span class="p">,</span> <span class="s2">&quot;C2 N2 H21 H22&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;C6 O6&quot;</span><span class="p">,</span> <span class="s2">&quot;C5 N7&quot;</span><span class="p">),</span>
        <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span> <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;N1 C5 C6&quot;</span><span class="p">,</span> <span class="s2">&quot;C2 O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;C4 O4&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">ForceField</span><span class="o">.</span><span class="n">update_non_standard_mapping</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># parameters are defined here for the following (protein) forcefields:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;martini30nucleic&quot;</span>
        <span class="c1"># Charged types:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charges</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Qd&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;Qa&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;SQd&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;SQa&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;RQd&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;AQa&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>  <span class="c1"># @#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbcharges</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BB1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>  <span class="c1"># @#</span>
        <span class="c1"># Not all (eg Elnedyn) forcefields use backbone-backbone-sidechain angles and BBBB-dihedrals.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UseBBSAngles</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UseBBBBDihedrals</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">##################</span>
        <span class="c1"># DNA PARAMETERS #</span>
        <span class="c1">##################</span>

        <span class="c1"># DNA BACKBONE PARAMETERS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;atom&quot;</span><span class="p">:</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;Q0 SN0 SC2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># DNA BACKBONE CONNECTIVITY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">##################</span>
        <span class="c1"># RNA PARAMETERS # @ff</span>
        <span class="c1">##################</span>

        <span class="c1"># RNA BACKBONE PARAMETERS TUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;atom&quot;</span><span class="p">:</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;Q1n C6 N2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mi">25000</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.378</span><span class="p">,</span> <span class="mi">12000</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.239</span><span class="p">,</span> <span class="mi">25000</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.412</span><span class="p">,</span> <span class="mi">12000</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">110.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>  <span class="c1"># 2, 117.0, 140</span>
                <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">121.0</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">143.0</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">112.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[(),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># RNA BACKBONE CONNECTIVITY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># For bonds, angles, and dihedrals the first parameter should always</span>
        <span class="c1"># be the type. It is pretty annoying to check the connectivity from</span>
        <span class="c1"># elsewhere so we update these one base at a time.</span>

        <span class="n">a_itp</span><span class="p">,</span> <span class="n">c_itp</span><span class="p">,</span> <span class="n">g_itp</span><span class="p">,</span> <span class="n">u_itp</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">read_itps</span><span class="p">(</span><span class="n">rna_system</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">)</span>

        <span class="c1"># ADENINE</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TA0 TA1 TA2 TA3 TA4&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini30nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">a_itp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_adenine</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="c1"># CYTOSINE</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TY0 TY1 TY2 TY3&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini30nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">c_itp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cytosine</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="c1"># GUANINE</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TG0 TG1 TG2 TG3 TG4 TG5&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini30nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">g_itp</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_guanine</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="c1"># URACIL</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TU0 TU1 TU2 TU3&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini30nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">u_itp</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_uracil</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>



<div class="viewcode-block" id="martini31nucleic">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.martini31nucleic">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">martini31nucleic</span><span class="p">(</span><span class="n">ForceField</span><span class="p">):</span>

    <span class="c1"># FF mapping</span>
    <span class="n">bb_mapping</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">(</span>
        <span class="s2">&quot;P OP1 OP2 O5&#39; O3&#39; O1P O2P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C5&#39; 1H5&#39; 2H5&#39; H5&#39; H5&#39;&#39; C4&#39; H4&#39; O4&#39; C3&#39; H3&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C1&#39; C2&#39; O2&#39; O4&#39;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span>
        <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span>
            <span class="s2">&quot;C8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N3 C4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N6 C6 H61 H62&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N7 C5&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span> <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;C6&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N4 C4 H41 H42&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">),</span>
        <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span>
        <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span><span class="s2">&quot;C8&quot;</span><span class="p">,</span> <span class="s2">&quot;C4 N3&quot;</span><span class="p">,</span> <span class="s2">&quot;C2 N2 H22 H21&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;O6&quot;</span><span class="p">,</span> <span class="s2">&quot;C5 N7&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">),</span>
        <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="n">bb_mapping</span>
        <span class="o">+</span> <span class="n">nsplit</span><span class="p">(</span>
            <span class="s2">&quot;C6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;O2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;O4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;H3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C4&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">}</span>

    <span class="n">ForceField</span><span class="o">.</span><span class="n">update_non_standard_mapping</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># parameters are defined here for the following (protein) forcefields:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;martini31nucleic&quot;</span>

        <span class="c1"># Charged types:</span>
        <span class="n">charges</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;TDU&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TA1&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
            <span class="s2">&quot;TA2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">&quot;TA3&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TA4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="s2">&quot;TA5&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="s2">&quot;TA6&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">,</span>
            <span class="s2">&quot;TY1&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;TY2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TY3&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="s2">&quot;TY4&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="s2">&quot;TY5&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TG1&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">&quot;TG2&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;TG3&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">&quot;TG4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">&quot;TG5&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TG6&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="s2">&quot;TG7&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">&quot;TG8&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TU1&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;TU2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TU3&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TU4&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TU5&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TU6&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;TU7&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charges</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="o">*</span> <span class="mf">1.8</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">charges</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbcharges</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BB1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

        <span class="c1"># Not all (eg Elnedyn) forcefields use backbone-backbone-sidechain angles and BBBB-dihedrals.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UseBBSAngles</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UseBBBBDihedrals</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">##################</span>
        <span class="c1"># DNA PARAMETERS #</span>
        <span class="c1">##################</span>

        <span class="c1"># DNA BACKBONE PARAMETERS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dna_bb</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;atom&quot;</span><span class="p">:</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;Q0 SN0 SC2&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># DNA BACKBONE CONNECTIVITY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dna_con</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_connectivity</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">##################</span>
        <span class="c1"># RNA PARAMETERS # @ff</span>
        <span class="c1">##################</span>

        <span class="c1"># RNA BACKBONE PARAMETERS TUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_bb</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;atom&quot;</span><span class="p">:</span> <span class="n">spl</span><span class="p">(</span><span class="s2">&quot;Q1 N4 N6&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.349</span><span class="p">,</span> <span class="mi">18000</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.377</span><span class="p">,</span> <span class="mi">12000</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.240</span><span class="p">,</span> <span class="mi">18000</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.412</span><span class="p">,</span> <span class="mi">12000</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">119.0</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">118.0</span><span class="p">,</span> <span class="mi">140</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">138.0</span><span class="p">,</span> <span class="mi">180</span><span class="p">)],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">7</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">25</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">6</span><span class="p">,</span>
                    <span class="mi">25</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">),</span>  <span class="c1"># (3,   10,  -8, 22, 8, -26, -6) # (3,   4,  -3, 9, 3, -10, -3)</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">112.0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">],</span>  <span class="c1"># (1,     15.0,   5, 1)</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[(),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># RNA BACKBONE CONNECTIVITY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_con</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bond&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;dih&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;excl&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="n">a_itp</span><span class="p">,</span> <span class="n">c_itp</span><span class="p">,</span> <span class="n">g_itp</span><span class="p">,</span> <span class="n">u_itp</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">read_itps</span><span class="p">(</span><span class="n">rna_system</span><span class="p">,</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">)</span>

        <span class="c1"># ADENINE</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TA1 TA2 TA3 TA4 TA5 TA6&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini31nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">a_itp</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_adenine</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="c1"># CYTOSINE</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TY1 TY2 TY3 TY4 TY5&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini31nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">c_itp</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cytosine</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="c1"># GUANINE</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TG1 TG2 TG3 TG4 TG5 TG6 TG7 TG8&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini31nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">g_itp</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_guanine</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="c1"># URACIL</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">spl</span><span class="p">(</span><span class="s2">&quot;TU1 TU2 TU3 TU4 TU5 TU6 TU7&quot;</span><span class="p">)]</span>
        <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span> <span class="o">=</span> <span class="n">martini31nucleic</span><span class="o">.</span><span class="n">itp_to_indata</span><span class="p">(</span><span class="n">u_itp</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">itp_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_uracil</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">itp_params</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>



<span class="c1">#########################</span>
<span class="c1">## 7 # ELASTIC NETWORK ##  -&gt; @ELN &lt;-</span>
<span class="c1">#########################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="c1">## ELASTIC NETWORK ##</span>

<span class="c1"># Only the decay function is defined here, the network</span>
<span class="c1"># itself is set up through the Topology class</span>


<span class="c1"># The function to determine the decay scaling factor for the elastic network</span>
<span class="c1"># force constant, based on the distance and the parameters provided.</span>
<span class="c1"># This function is very versatile and can be fitted to most commonly used</span>
<span class="c1"># profiles, including a straight line (rate=0)</span>
<div class="viewcode-block" id="decayFunction">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.decayFunction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">decayFunction</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">rate</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">distance</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="n">power</span><span class="p">))</span></div>



<div class="viewcode-block" id="rubberBands">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.rubberBands">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rubberBands</span><span class="p">(</span>
    <span class="n">atomList</span><span class="p">,</span>
    <span class="n">lowerBound</span><span class="p">,</span>
    <span class="n">upperBound</span><span class="p">,</span>
    <span class="n">decayFactor</span><span class="p">,</span>
    <span class="n">decayPower</span><span class="p">,</span>
    <span class="n">forceConstant</span><span class="p">,</span>
    <span class="n">minimumForce</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">upperBound</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">bi</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="n">atomList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># This is a bit weird (=wrong I think) way of doing the cutoff...</span>
        <span class="c1"># for bj,xj in atomList[2:]:</span>
        <span class="k">for</span> <span class="n">bj</span><span class="p">,</span> <span class="n">xj</span> <span class="ow">in</span> <span class="n">atomList</span><span class="p">:</span>
            <span class="c1"># Mind the nm/A conversion -- This has to be standardized! Global use of nm?</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">distance2</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="n">u2</span><span class="p">:</span>
                <span class="n">dij</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
                <span class="n">fscl</span> <span class="o">=</span> <span class="n">decayFunction</span><span class="p">(</span><span class="n">dij</span><span class="p">,</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="n">decayFactor</span><span class="p">,</span> <span class="n">decayPower</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fscl</span> <span class="o">*</span> <span class="n">forceConstant</span> <span class="o">&gt;</span> <span class="n">minimumForce</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;atoms&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">bj</span><span class="p">),</span> <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">dij</span><span class="p">,</span> <span class="s2">&quot;RUBBER_FC*</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fscl</span><span class="p">)}</span>
                    <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<span class="c1">#######################</span>
<span class="c1">## 8 # STRUCTURE I/O ##  -&gt; @IO &lt;-</span>
<span class="c1">#######################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span><span class="o">,</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">random</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>

<span class="c1"># ----+---------+</span>
<span class="c1">## A | PDB I/O |</span>
<span class="c1"># ----+---------+</span>

<span class="n">d2r</span> <span class="o">=</span> <span class="mf">3.14159265358979323846264338327950288</span> <span class="o">/</span> <span class="mi">180</span>

<span class="c1"># Reformatting of lines in structure file</span>
<span class="n">pdbAtomLine</span> <span class="o">=</span> <span class="s2">&quot;ATOM  </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%4s%4s</span><span class="s2"> </span><span class="si">%1s%4d%1s</span><span class="s2">   </span><span class="si">%8.3f%8.3f%8.3f%6.2f%6.2f</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">pdbBoxLine</span> <span class="o">=</span> <span class="s2">&quot;CRYST1</span><span class="si">%9.3f%9.3f%9.3f%7.2f%7.2f%7.2f</span><span class="s2"> P 1           1</span><span class="se">\n</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="pdbBoxString">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pdbBoxString">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pdbBoxString</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>
    <span class="c1"># Box vectors</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="c1"># Box vector lengths</span>
    <span class="n">nu</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">nw</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm2</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">)]</span>
    <span class="c1"># Box vector angles</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">nv</span> <span class="o">*</span> <span class="n">nw</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mi">90</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="o">/</span> <span class="n">d2r</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nw</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mi">90</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="o">/</span> <span class="n">d2r</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nv</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mi">90</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">/</span> <span class="n">d2r</span>
    <span class="k">return</span> <span class="n">pdbBoxLine</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span></div>



<div class="viewcode-block" id="pdbAtom">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pdbAtom">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pdbAtom</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1">##01234567890123456789012345678901234567890123456789012345678901234567890123456789</span>
    <span class="c1">##ATOM   2155 HH11 ARG C 203     116.140  48.800   6.280  1.00  0.00</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TER&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># NOTE: The 27th field of an ATOM line in the PDB definition can contain an</span>
    <span class="c1">#       insertion code. We shift that 20 bits and add it to the residue number</span>
    <span class="c1">#       to ensure that residue numbers will be unique.</span>
    <span class="c1">## ===&gt; atom name,       res name,        res id,                        chain,</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">26</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span>
        <span class="c1">##            x,              y,              z</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">]),</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="pdbOut">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pdbOut">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pdbOut</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">insc</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span>
    <span class="n">resi</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">insc</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">pdbline</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;ATOM  </span><span class="si">%5i</span><span class="s2">  </span><span class="si">%-3s</span><span class="s2"> </span><span class="si">%3s%2s%4i%1s</span><span class="s2">   </span><span class="si">%8.3f%8.3f%8.3f%6.2f%6.2f</span><span class="s2">           </span><span class="si">%1s</span><span class="s2">  </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pdbline</span> <span class="o">%</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">resi</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">insc</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">atom</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="isPdbAtom">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.isPdbAtom">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">isPdbAtom</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-hetatm&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HETATM&quot;</span><span class="p">))</span>
        <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TER&quot;</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="pdbBoxRead">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pdbBoxRead">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pdbBoxRead</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">ac</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]]</span>
    <span class="n">ca</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="n">aa</span><span class="p">),</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="n">ab</span><span class="p">),</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="n">ac</span><span class="p">),</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span> <span class="o">*</span> <span class="n">ac</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">wx</span><span class="p">,</span> <span class="n">wy</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="n">cb</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="p">(</span><span class="n">ca</span> <span class="o">-</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cg</span><span class="p">)</span> <span class="o">/</span> <span class="n">sg</span>
    <span class="n">wz</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">wx</span> <span class="o">-</span> <span class="n">wy</span> <span class="o">*</span> <span class="n">wy</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">fa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fb</span> <span class="o">*</span> <span class="n">cg</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fb</span> <span class="o">*</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">]</span></div>



<span class="c1"># Function for splitting a PDB file in chains, based</span>
<span class="c1"># on chain identifiers and TER statements</span>
<div class="viewcode-block" id="pdbChains">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pdbChains">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pdbChains</span><span class="p">(</span><span class="n">pdbAtomList</span><span class="p">):</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">pdbAtomList</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>  <span class="c1"># Was a &quot;TER&quot; statement</span>
            <span class="k">if</span> <span class="n">chain</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">chain</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping empty chain definition&quot;</span><span class="p">)</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chain</span> <span class="ow">or</span> <span class="n">chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chain</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">chain</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">chain</span></div>



<span class="c1"># Simple PDB iterator</span>
<div class="viewcode-block" id="pdbFrameIterator">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.pdbFrameIterator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pdbFrameIterator</span><span class="p">(</span><span class="n">streamIterator</span><span class="p">):</span>
    <span class="n">title</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">box</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">streamIterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ENDMDL&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title</span><span class="p">),</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">box</span>
            <span class="n">title</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">box</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">):</span>
            <span class="n">title</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;CRYST1&quot;</span><span class="p">):</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">pdbBoxRead</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HETATM&quot;</span><span class="p">):</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdbAtom</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title</span><span class="p">),</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">box</span></div>



<span class="c1"># ----+-------------+</span>
<span class="c1">## C | GENERAL I/O |</span>
<span class="c1"># ----+-------------+</span>


<span class="c1"># It is not entirely clear where this fits in best.</span>
<span class="c1"># Called from main.</span>
<div class="viewcode-block" id="getChargeType">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.getChargeType">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getChargeType</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">choices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get user input for the charge of residues, based on list with</span>
<span class="sd">    choises.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Which </span><span class="si">%s</span><span class="s2"> type do you want for residue </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">resid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">choices</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">choice</span><span class="p">))</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choices</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Type a number:&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">choices</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span></div>



<span class="c1"># *NOTE*: This should probably be a CheckableStream class that</span>
<span class="c1"># reads in lines until either of a set of specified conditions</span>
<span class="c1"># is met, then setting the type and from thereon functioning as</span>
<span class="c1"># a normal stream.</span>
<div class="viewcode-block" id="streamTag">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.streamTag">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">streamTag</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
    <span class="c1"># Tag the stream with the type of structure file</span>
    <span class="c1"># If necessary, open the stream, taking care of</span>
    <span class="c1"># opening using gzip for gzipped files</span>

    <span class="c1"># First check whether we have have an open stream or a file</span>
    <span class="c1"># If it&#39;s a file, check whether it&#39;s zipped and open it</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stream</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;gz&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read input structure from zipped file.&quot;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read input structure from file.&quot;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read input structure from command-line&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">stream</span>

    <span class="c1"># Read a few lines, but save them</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">readline</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="c1"># Must be a GRO file</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Input structure is a GRO file. Chains will be labeled consecutively.&quot;</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="s2">&quot;GRO&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Must be a PDB file then</span>
        <span class="c1"># Could wind further to see if we encounter an &quot;ATOM&quot; record</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input structure is a PDB file.&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s2">&quot;PDB&quot;</span>

    <span class="c1"># Hand over the lines that were stored</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>

    <span class="c1"># Now give the rest of the lines from the stream</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span></div>



<span class="c1"># ----+-----------------+</span>
<span class="c1">## D | STRUCTURE STUFF |</span>
<span class="c1"># ----+-----------------+</span>


<span class="c1"># This list allows to retrieve atoms based on the name or the index</span>
<span class="c1"># If standard, dictionary type indexing is used, only exact matches are</span>
<span class="c1"># returned. Alternatively, partial matching can be achieved by setting</span>
<span class="c1"># a second &#39;True&#39; argument.</span>
<div class="viewcode-block" id="Residue">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Residue">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Residue</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="c1"># Call the parent class __getitem__</span>
            <span class="k">return</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># Return partial matches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># Return exact matches only</span></div>



<div class="viewcode-block" id="residues">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.residues">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">residues</span><span class="p">(</span><span class="n">atomList</span><span class="p">):</span>
    <span class="n">residue</span> <span class="o">=</span> <span class="p">[</span><span class="n">atomList</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomList</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">residue</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Residue name check</span>
            <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">residue</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Residue id check</span>
            <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">residue</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>  <span class="c1"># Chain id check</span>
            <span class="n">residue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Residue</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
            <span class="n">residue</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">Residue</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span></div>



<div class="viewcode-block" id="residueDistance2">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.residueDistance2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">residueDistance2</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">([</span><span class="n">distance2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">r2</span><span class="p">])</span></div>



<span class="c1"># Increased the cut-off from 2.5 to 3.0 for DNA. Should check that no problems arise for proteins.</span>
<div class="viewcode-block" id="breaks">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.breaks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">breaks</span><span class="p">(</span>
    <span class="n">residuelist</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O5&#39;&quot;</span><span class="p">),</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">3.0</span>
<span class="p">):</span>
    <span class="c1"># Extract backbone atoms coordinates</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span> <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residuelist</span>
    <span class="p">]</span>
    <span class="c1"># Needed to remove waters residues from mixed residues.</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">bb</span> <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="p">[]]</span>
    <span class="c1"># We cannot rely on some standard order for the backbone atoms.</span>
    <span class="c1"># Therefore breaks are inferred from the minimal distance between</span>
    <span class="c1"># backbone atoms from adjacent residues.</span>
    <span class="n">breaks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">residueDistance2</span><span class="p">(</span><span class="n">bb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bb</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">breaks</span></div>



<div class="viewcode-block" id="contacts">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.contacts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">contacts</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">rla</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
    <span class="n">crd</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rla</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">rla</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">distance2</span><span class="p">(</span><span class="n">crd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">crd</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">cutoff</span>
    <span class="p">]</span></div>



<div class="viewcode-block" id="add_dummy">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.add_dummy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_dummy</span><span class="p">(</span><span class="n">beads</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mf">0.11</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># Generate a random vector in a sphere of -1 to +1, to add to the bead position</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c1"># Calculated the length of the vector and divide by the final distance of the dummy bead</span>
    <span class="n">norm_v</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">dist</span>
    <span class="c1"># Resize the vector</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">norm_v</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="c1"># m sets the direction of the added vector, currently only works when adding one or two beads.</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="s2">&quot;SCD&quot;</span>
        <span class="n">newBead</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">newName</span><span class="p">,</span>
            <span class="nb">tuple</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">beads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">vn</span><span class="p">)]),</span>
            <span class="n">beads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">beads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBead</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">beads</span></div>



<div class="viewcode-block" id="check_merge">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.check_merge">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_merge</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">m_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">l_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">ss_cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">chainIndex</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">m_list</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All chains will be merged in a single moleculetype.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chainIndex</span><span class="p">,</span> <span class="p">[</span><span class="n">chainIndex</span><span class="p">]</span>
    <span class="n">chainID</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span><span class="o">.</span><span class="n">_id</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">]</span>
    <span class="c1"># Mark the combinations of chains that need to be merged</span>
    <span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m_list</span><span class="p">:</span>
        <span class="c1"># Build a dictionary of chain IDs versus index</span>
        <span class="c1"># To give higher priority to top chains the lists are reversed</span>
        <span class="c1"># before building the dictionary</span>
        <span class="n">chainIndex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">chainIndex</span><span class="p">))</span>
        <span class="n">chainID</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">chainID</span><span class="p">))</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">chainID</span><span class="p">,</span> <span class="n">chainIndex</span><span class="p">))</span>
        <span class="n">chainIndex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">chainIndex</span><span class="p">))</span>
        <span class="c1"># Convert chains in the merge_list to numeric, if necessary</span>
        <span class="c1"># NOTE The internal numbering is zero-based, while the</span>
        <span class="c1"># command line chain indexing is one-based. We have to add</span>
        <span class="c1"># one to the number in the dictionary to bring it on par with</span>
        <span class="c1"># the numbering from the command line, but then from the</span>
        <span class="c1"># result we need to subtract one again to make indexing</span>
        <span class="c1"># zero-based</span>
        <span class="c1"># merges = [[(i.isdigit() and int(i) or dct[i]+1)-1 for i in j] for j in m_list]</span>
        <span class="n">merges</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1"># Rearrange merge list to a list of pairs</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merges</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="c1"># Check each combination of chains for connections based on</span>
    <span class="c1"># ss-bridges, links and distance restraints</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chainIndex</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">chainIndex</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Check whether any link links these two groups</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">a</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Merging chains </span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2"> to allow link </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)))</span>
                    <span class="p">)</span>
                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="c1"># Sort the combinations</span>
    <span class="n">pairs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">merges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pairs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">merges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pairs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">merges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
        <span class="n">i</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merges</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">merges</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Merging chains.&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;This may change the order of atoms and will change the number of topology files.&quot;</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merges: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">([</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">merges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">merges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">chainIndex</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All chains will be merged in a single moleculetype&quot;</span><span class="p">)</span>
    <span class="c1"># Determine the order for writing; merged chains go first</span>
    <span class="n">merges</span><span class="o">.</span><span class="n">extend</span><span class="p">([[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">chainIndex</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span>
    <span class="n">order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">chainIndex</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">order</span><span class="p">,</span> <span class="n">merges</span></div>



<span class="c1">## !! NOTE !! ##</span>
<span class="c1">## XXX The chain class needs to be simplified by extracting things to separate functions/classes</span>
<div class="viewcode-block" id="Chain">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Chain</span><span class="p">:</span>
    <span class="c1"># Attributes defining a chain</span>
    <span class="c1"># When copying a chain, or slicing, the attributes in this list have to</span>
    <span class="c1"># be handled accordingly.</span>
    <span class="n">_attributes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;residues&quot;</span><span class="p">,</span> <span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;seq&quot;</span><span class="p">,</span> <span class="s2">&quot;ss&quot;</span><span class="p">,</span> <span class="s2">&quot;ssclass&quot;</span><span class="p">,</span> <span class="s2">&quot;sstypes&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">residuelist</span><span class="o">=</span><span class="p">[],</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiscale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="o">=</span> <span class="n">residuelist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residuelist</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residuelist</span><span class="p">]</span>
        <span class="c1"># *NOTE*: Check for unknown residues and remove them if requested</span>
        <span class="c1">#         before proceeding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">AA321</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ss</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssclass</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sstypes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiscale</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>

        <span class="c1"># Unknown residues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unknowns</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span>

        <span class="c1"># Determine the type of chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>

        <span class="c1"># Determine number of atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="p">)</span>

        <span class="c1"># BREAKS: List of indices of residues where a new fragment starts</span>
        <span class="c1"># Only when polymeric (protein, DNA, RNA, ...)</span>
        <span class="c1"># For now, let&#39;s remove it for the Nucleic acids...</span>
        <span class="c1"># self.breaks     = self.type() in (&quot;Protein&quot;, &quot;Mixed&quot;, &quot;Nucleic&quot;) and breaks(self.residues) or []</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span> <span class="o">=</span> <span class="n">breaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>

        <span class="c1"># LINKS:  List of pairs of pairs of indices of linked residues/atoms</span>
        <span class="c1"># This list is used for cysteine bridges and peptide bonds involving side chains</span>
        <span class="c1"># The list has items like ((#resi1, #atid1), (#resi2, #atid2))</span>
        <span class="c1"># When merging chains, the residue number needs ot be update, but the atom id</span>
        <span class="c1"># remains unchanged.</span>
        <span class="c1"># For the coarse grained system, it needs to be checked which beads the respective</span>
        <span class="c1"># atoms fall in, and bonded terms need to be added there.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Chain identifier; try to read from residue definition if no name is given</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">residuelist</span> <span class="ow">and</span> <span class="n">residuelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Container for coarse grained beads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cg</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return the number of residues</span>
        <span class="c1"># DNA/RNA contain non-CAP d/r to indicate type. We remove those first.</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isupper</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">newchain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="c1"># Combine the chain items that can be simply added</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newchain</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="c1"># Set chain items, shifting the residue numbers</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">breaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span> <span class="o">+</span> <span class="p">[</span><span class="n">shift</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">shift</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">breaks</span><span class="p">]</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">+</span> <span class="p">[</span>
            <span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">,</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">links</span>
        <span class="p">]</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newchain</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">multiscale</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Return the merged chain</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">newchain</span><span class="o">.</span><span class="n">breaks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newchain</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">seq</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ss</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">breaks</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">links</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiscale</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="p">)</span>

    <span class="c1"># Extract a residue by number or the list of residues of a given type</span>
    <span class="c1"># This facilitates selecting residues for links, like chain[&quot;CYS&quot;]</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># This functionality is set up for links</span>
            <span class="c1"># between coarse grained beads. So these are</span>
            <span class="c1"># checked first,</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="n">i</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">other</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">other</span><span class="p">]</span>

    <span class="c1"># Extract a piece of a chain as a new chain</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">newchain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="c1"># Extract the slices from all lists</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newchain</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># Breaks that fall within the start and end of this chain need to be passed on.</span>
        <span class="c1"># Residue numbering is increased by 20 bits!!</span>
        <span class="c1"># XXX I don&#39;t know if this works.</span>
        <span class="n">ch_sta</span><span class="p">,</span> <span class="n">ch_end</span> <span class="o">=</span> <span class="n">newchain</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">newchain</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">breaks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">crack</span> <span class="k">for</span> <span class="n">crack</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">breaks</span> <span class="k">if</span> <span class="n">ch_sta</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">crack</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ch_end</span>
        <span class="p">]</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="k">if</span> <span class="n">ch_sta</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">link</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ch_end</span><span class="p">]</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">multiscale</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newchain</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
        <span class="n">newchain</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
        <span class="c1"># Return the chain slice</span>
        <span class="k">return</span> <span class="n">newchain</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomlist</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
        <span class="n">atnm</span><span class="p">,</span> <span class="n">resn</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">chn</span> <span class="o">=</span> <span class="n">atom</span>

        <span class="c1"># If the chain does not match, bail out</span>
        <span class="k">if</span> <span class="n">chn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if the whole tuple is in</span>
        <span class="k">if</span> <span class="n">atnm</span> <span class="ow">and</span> <span class="n">resn</span> <span class="ow">and</span> <span class="n">resi</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">atnm</span><span class="p">,</span> <span class="n">resn</span><span class="p">,</span> <span class="n">resi</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span>

        <span class="c1"># Fetch atoms with matching residue id</span>
        <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">resi</span><span class="p">)</span> <span class="ow">and</span> <span class="n">atomlist</span> <span class="ow">or</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">atomlist</span> <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">resi</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Select atoms with matching residue name</span>
        <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">resn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">match</span> <span class="ow">or</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">resn</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check whether the atom is given and listed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">atnm</span> <span class="ow">or</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">atnm</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># It just is not in the list!</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">(),</span> <span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">(),</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Chain.atoms">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.atoms">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span></div>


    <span class="c1"># Split a chain based on residue types; each subchain can have only one type</span>
<div class="viewcode-block" id="Chain.split">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.split">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chainStart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">residueTypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">residueTypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Unknown&quot;</span>
            <span class="p">):</span>
                <span class="c1"># Use the __getslice__ method to take a part of the chain.</span>
                <span class="n">chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">chainStart</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">chainStart</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">chains</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Splitting chain </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> chains&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">chains</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">chainStart</span><span class="p">:]]</span></div>


<div class="viewcode-block" id="Chain.getname">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.getname">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">basename</span><span class="p">:</span>
            <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">basename</span><span class="p">:</span>
            <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Chain.set_ss">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.set_ss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_ss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;self&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ss</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">*</span> <span class="n">ss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ss</span> <span class="o">=</span> <span class="n">ss</span>
        <span class="c1"># Infer the Martini backbone secondary structure types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstypes</span> <span class="o">=</span> <span class="n">ssClassification</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span></div>


<div class="viewcode-block" id="Chain.dss">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.dss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># The method should take a list of atoms and return a</span>
        <span class="c1"># string of secondary structure classifications</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Protein&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">atomlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_ss</span><span class="p">(</span>
                    <span class="n">ssDetermination</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomlist</span><span class="p">,</span> <span class="n">executable</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="n">method</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_ss</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ss</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span></div>


<div class="viewcode-block" id="Chain.type">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Determine the type of chain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">residueTypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;Mixed&quot;</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span></div>


    <span class="c1"># XXX The following (at least the greater part of it) should be made a separate function, put under &quot;MAPPING&quot;</span>
<div class="viewcode-block" id="Chain.cg">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.cg">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">com</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Generate the coarse grained structure</span>
        <span class="c1"># Set the b-factor field to something that reflects the secondary structure</span>

        <span class="c1"># If the coarse grained structure is set already, just return,</span>
        <span class="c1"># unless regeneration is forced.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atid</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">residue</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">resname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sstypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">):</span>
            <span class="c1"># For DNA we need to get the O3&#39; to the following residue when calculating COM</span>
            <span class="c1"># The force and com options ensure that this part does not affect itp generation or anything else</span>
            <span class="k">if</span> <span class="n">com</span><span class="p">:</span>
                <span class="c1"># Just an initialization, this should complain if it isn&#39;t updated in the loop</span>
                <span class="n">store</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">residue</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;O3&#39;&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">previous</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">residue</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous</span>
                            <span class="n">previous</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">store</span> <span class="o">=</span> <span class="n">ind</span>
                            <span class="n">previous</span> <span class="o">=</span> <span class="n">i</span>
                <span class="c1"># We couldn&#39;t remove the O3&#39; from the 5&#39; end residue during the loop so we do it now</span>
                <span class="k">if</span> <span class="n">store</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">residue</span><span class="p">[</span><span class="n">store</span><span class="p">]</span>

            <span class="c1"># Check if residues names has changed, for example because user has set residues interactively.</span>
            <span class="n">residue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">resname</span><span class="p">)</span> <span class="o">+</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SOL&quot;</span><span class="p">,</span> <span class="s2">&quot;HOH&quot;</span><span class="p">,</span> <span class="s2">&quot;TIP&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">str2ff</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;martini30nucleic&quot;</span><span class="p">:</span> <span class="n">martini30nucleic</span><span class="p">,</span>
                <span class="s2">&quot;martini31nucleic&quot;</span><span class="p">:</span> <span class="n">martini31nucleic</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ffname</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">str2ff</span><span class="p">[</span><span class="n">ffname</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipped unknown residue </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="c1"># Get the mapping for this residue</span>
            <span class="c1"># CG.map returns bead coordinates and mapped atoms</span>
            <span class="c1"># This will fail if there are (too many) atoms missing, which is</span>
            <span class="c1"># only problematic if a mapped structure is written; the topology</span>
            <span class="c1"># is inferred from the sequence. So this is the best place to raise</span>
            <span class="c1"># an error</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># The last residue, in the case of a polBB has only a CA-positioned bead.</span>
                <span class="n">beads</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span>
                <span class="n">beads</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">CoarseGrained</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="n">beads</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Too many atoms missing from residue </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">(ch:</span><span class="si">%s</span><span class="s2">):&quot;</span><span class="p">,</span>
                    <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span>
                    <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">repr</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">]))</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">beads</span><span class="p">:</span>
                <span class="c1"># Add the bead with coordinates and secondary structure id to the list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                        <span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">,</span>
                        <span class="n">z</span><span class="p">,</span>
                        <span class="n">ss2num</span><span class="p">[</span><span class="n">rss</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Add the ids to the list, after converting them to indices to the list of atoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atid</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>

            <span class="c1"># Increment the atom id; This pertains to the atoms that are included in the output.</span>
            <span class="n">atid</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>

            <span class="c1"># Keep track of the numbers for CONECTing</span>
            <span class="n">bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">beads</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unable to generate coarse grained structure due to missing atoms.&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cg</span></div>


<div class="viewcode-block" id="Chain.conect">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Chain.conect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">conect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return pairs of numbers that should be CONECTed</span>
        <span class="c1"># First extract the backbone IDs</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">()</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cg</span><span class="p">)),</span> <span class="n">cg</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;BB&quot;</span><span class="p">]</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)])</span>
        <span class="c1"># Set the backbone CONECTs (check whether the distance is consistent with binding)</span>
        <span class="n">conect</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">distance2</span><span class="p">(</span><span class="n">cg</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="n">cg</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">14</span>
        <span class="p">]</span>
        <span class="c1"># Now add CONECTs for sidechains</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
            <span class="n">nsc</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span></div>
</div>



<span class="c1">##################</span>
<span class="c1">## 7 # TOPOLOGY ##  -&gt; @TOP &lt;-</span>
<span class="c1">##################</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span><span class="o">,</span><span class="w"> </span><span class="nn">math</span>


<span class="c1"># This is a generic class for Topology Bonded Type definitions</span>
<div class="viewcode-block" id="Bonded">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Bonded">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Bonded</span><span class="p">:</span>
    <span class="c1"># The init method is generic to the bonded types,</span>
    <span class="c1"># but may call the set method if atoms are given</span>
    <span class="c1"># as (ID, ResidueName, SecondaryStructure) tuples</span>
    <span class="c1"># The set method is specific to the different types.</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
            <span class="c1"># If other is given, then copy the attributes</span>
            <span class="c1"># if it is of the same class or set the</span>
            <span class="c1"># attributes according to the key names if</span>
            <span class="c1"># it is a dictionary</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">other</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">other</span>

        <span class="c1"># For every item in the kwargs keys, set the attribute</span>
        <span class="c1"># with the same name. This can be used to specify the</span>
        <span class="c1"># attributes directly or to override attributes</span>
        <span class="c1"># copied from the &#39;other&#39; argument.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c1"># If atoms are given as tuples of</span>
        <span class="c1"># (ID, ResidueName[, SecondaryStructure])</span>
        <span class="c1"># then determine the corresponding parameters</span>
        <span class="c1"># from the lists above</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%5d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="c1"># For exclusions, no type is defined, which equals -1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%5d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="c1"># Print integers and floats in proper format and neglect None terms</span>
        <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">formatString</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">num</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">atoms</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">parameters</span>
            <span class="p">)</span>

    <span class="c1"># This function needs to be overridden for descendents</span>
<div class="viewcode-block" id="Bonded.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Bonded.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>



<span class="c1"># The set method of this class will look up parameters for backbone beads</span>
<span class="c1"># Side chain bonds ought to be set directly, using the constructor</span>
<span class="c1"># providing atom numbers, bond type, and parameters</span>
<span class="c1"># Constraints are bonds with kb = 100000.00000, which can be extracted</span>
<span class="c1"># using the category</span>
<div class="viewcode-block" id="Bond">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Bond">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Bond</span><span class="p">(</span><span class="n">Bonded</span><span class="p">):</span>
<div class="viewcode-block" id="Bond.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Bond.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positionCa</span> <span class="o">=</span> <span class="n">ca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># The category can be used to keep bonds sorted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bbGetBond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
        <span class="c1"># If there are more than two parameters given, user HAS TO define the bond type as the first one.</span>
        <span class="c1"># This is to allow use of any gromacs bond type.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c1"># Backbone bonds also can be constraints. We could change the type further on, but this is more general.</span>
        <span class="c1"># Even better would be to add a new type: BB-Constraint</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;100000.00000&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="s2">&quot;Constraint&quot;</span></div>
</div>


    <span class="c1"># Overriding __str__ method to suppress printing of bonds with Fc of 0</span>
    <span class="c1"># def __str__(self):</span>
    <span class="c1">#     if not self.parameters:</span>
    <span class="c1">#         return &quot;&quot;</span>
    <span class="c1">#     return Bonded.__str__(self)</span>


<span class="c1"># Similar to the preceding class</span>
<div class="viewcode-block" id="Angle">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Angle">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Angle</span><span class="p">(</span><span class="n">Bonded</span><span class="p">):</span>
<div class="viewcode-block" id="Angle.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Angle.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positionCa</span> <span class="o">=</span> <span class="n">ca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bbGetAngle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
        <span class="c1"># If there are more than two parameters given, user HAS TO define the angle type as the first one.</span>
        <span class="c1"># This is to allow use of any gromacs angle type.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>
</div>



<span class="c1"># Similar to the preceding class</span>
<div class="viewcode-block" id="Vsite">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Vsite">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Vsite</span><span class="p">(</span><span class="n">Bonded</span><span class="p">):</span>
<div class="viewcode-block" id="Vsite.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Vsite.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positionCa</span> <span class="o">=</span> <span class="n">ca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># s = [&quot;%5d&quot; % i for i in self.atoms]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">formatString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>



<span class="c1"># Similar to the preceding class</span>
<div class="viewcode-block" id="Exclusion">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Exclusion">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Exclusion</span><span class="p">(</span><span class="n">Bonded</span><span class="p">):</span>
<div class="viewcode-block" id="Exclusion.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Exclusion.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positionCa</span> <span class="o">=</span> <span class="n">ca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bbGetExclusion</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span></div>
</div>



<span class="c1"># Similar to the preceding class</span>
<div class="viewcode-block" id="Pair">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Pair">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Pair</span><span class="p">(</span><span class="n">Bonded</span><span class="p">):</span>
<div class="viewcode-block" id="Pair.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Pair.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positionCa</span> <span class="o">=</span> <span class="n">ca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bbGetPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span></div>
</div>



<span class="c1"># Similar to the preceding class</span>
<div class="viewcode-block" id="Dihedral">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Dihedral">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Dihedral</span><span class="p">(</span><span class="n">Bonded</span><span class="p">):</span>
<div class="viewcode-block" id="Dihedral.set">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Dihedral.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positionCa</span> <span class="o">=</span> <span class="n">ca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">ss</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">ss</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bbGetDihedral</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
        <span class="c1"># If there are more than two parameters given, user HAS TO define the diheral type as the first one.</span>
        <span class="c1"># This is to allow use of any gromacs dihedral type.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>
</div>



<span class="c1"># This list allows to retrieve Bonded class items based on the category</span>
<span class="c1"># If standard, dictionary type indexing is used, only exact matches are</span>
<span class="c1"># returned. Alternatively, partial matching can be achieved by setting</span>
<span class="c1"># a second &#39;True&#39; argument.</span>
<div class="viewcode-block" id="CategorizedList">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.CategorizedList">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CategorizedList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="c1"># Call the parent class __getitem__</span>
            <span class="k">return</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">tag</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">category</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></div>



<div class="viewcode-block" id="Topology">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Topology">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Topology</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrexcl</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posres</span> <span class="o">=</span> <span class="n">CategorizedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secstruc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Okay, this is sort of funny; we will add a</span>
        <span class="c1">#   #define mapping virtual_sites3</span>
        <span class="c1"># to the topology file, followed by a header</span>
        <span class="c1">#   [ mapping ]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># For multiscaling we have to keep track of the number of</span>
        <span class="c1"># real atoms that correspond to the beads in the topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiscale</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="p">:</span>
            <span class="c1"># Returning an empty instance</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Topology</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;atoms&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vsites&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bonds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;angles&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span>
                <span class="s2">&quot;impropers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;constraints&quot;</span><span class="p">,</span>
                <span class="s2">&quot;posres&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrib</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attrib</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Chain</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Protein&quot;</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;polbb&quot;</span>
            <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fromAminoAcidSequencePolBB</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Protein&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fromAminoAcidSequence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Nucleic&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fromNucleicAcidSequence</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This chain should not be polymeric, but a collection of molecules</span>
                <span class="c1"># For each unique residue type fetch the proper moleculetype</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fromMoleculeList</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Topology</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">Topology</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">shift</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># Update atom numbers</span>
        <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">last</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="c1"># Update residue numbers</span>
        <span class="n">atoms</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">last</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>  <span class="c1"># Update charge group numbers</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">atoms</span><span class="p">))</span>
        <span class="c1"># The zippings above kills all atoms with specified mass (9 long lists)</span>
        <span class="c1"># Let&#39;s add some band aid to fix it...</span>
        <span class="c1"># This of course doesn&#39;t work if there was a secondary structure to keep</span>
        <span class="c1"># but think it affects at this stage only the output comment.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;bonds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vsites&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exclusions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;angles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;impropers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;constraints&quot;</span><span class="p">,</span>
            <span class="s2">&quot;posres&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">source</span> <span class="o">+</span> <span class="n">shift</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Topology</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Topology</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">Topology</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;; MARTINI (</span><span class="si">%s</span><span class="s1">) Coarse Grained topology file for &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">; Created by py version </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">; Using the following options:  &quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Arguments&quot;</span><span class="p">])</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">; #####################################################################################################&quot;</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">; This topology is based on development beta of Martini DNA and should NOT be used for production runs.&quot;</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">; #####################################################################################################&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;; Sequence:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">AA321</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">AA</span><span class="p">)</span> <span class="k">for</span> <span class="n">AA</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">]),</span>
                <span class="s2">&quot;; Secondary Structure:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">secstruc</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="c1"># Do not print a molecule name when multiscaling</span>
        <span class="c1"># In that case, the topology created here needs to be appended</span>
        <span class="c1"># at the end of an atomistic moleculetype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiscale</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ moleculetype ]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;; Name         Exclusions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2"> </span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrexcl</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ atoms ]&quot;</span><span class="p">)</span>

        <span class="c1"># For virtual sites and dummy beads we have to be able to specify the mass.</span>
        <span class="c1"># Thus we need two different format strings:</span>
        <span class="n">fs8</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%7.4f</span><span class="s2"> ; </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">fs9</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%7.4f</span><span class="s2"> </span><span class="si">%7.4f</span><span class="s2"> ; </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="n">fs9</span> <span class="o">%</span> <span class="n">i</span> <span class="ow">or</span> <span class="n">fs8</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>

        <span class="c1"># Print the pairs.</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ pairs ]&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>

        <span class="c1"># Print out the vsites only if they excist. Right now it can only be type 1 virual sites.</span>
        <span class="c1"># TODO: This needs to be generalized for all virtual site types.</span>
        <span class="n">vsitesBB</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="s2">&quot;BB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="n">vsitesSC</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="s2">&quot;SC&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">vsitesBB</span> <span class="ow">or</span> <span class="n">vsitesSC</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ virtual_sites3 ]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vsitesBB</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Backbone virtual sites.&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vsitesBB</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vsitesSC</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Sidechain virtual sites.&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vsitesSC</span><span class="p">)</span>

        <span class="c1"># Bonds in order: backbone, backbone-sidechain, sidechain, short elastic, long elastic</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ bonds ]&quot;</span><span class="p">)</span>
        <span class="c1"># Backbone-backbone</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;BB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Backbone bonds&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="c1"># Rubber Bands</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;Rubber&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="c1"># Add a CPP style directive to allow control over the elastic network</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#ifdef RUBBER_BANDS&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;#ifndef RUBBER_FC</span><span class="se">\n</span><span class="s2">#define RUBBER_FC </span><span class="si">%f</span><span class="se">\n</span><span class="s2">#endif&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMaximumForce&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#endif&quot;</span><span class="p">)</span>
        <span class="c1"># Backbone-Sidechain/Sidechain-Sidechain</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;SC&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Sidechain bonds&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="c1"># Short elastic/Long elastic</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;Elastic short&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Short elastic bonds for extended regions&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;Elastic long&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Long elastic bonds for extended regions&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="c1"># Cystine bridges</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;Cystine&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Cystine bridges&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="c1"># Other links</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;Link&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Links/Cystine bridges&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>

        <span class="c1"># Constraints</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ constraints ]&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="s2">&quot;Constraint&quot;</span><span class="p">]])</span>

        <span class="c1"># Print out the exclusions only if they excist.</span>
        <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">exclusions</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ exclusions ]&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span>

        <span class="c1"># Angles</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ angles ]&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Backbone angles&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="s2">&quot;BBB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Backbone-sidechain angles&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="s2">&quot;BBS&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Sidechain angles&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="s2">&quot;SC&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>

        <span class="c1"># Dihedrals</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ dihedrals ]&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Backbone dihedrals&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="s2">&quot;BBBB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">parameters</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Sidechain dihedrals&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="s2">&quot;BSC&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">parameters</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;; Sidechain improper dihedrals&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="s2">&quot;SC&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">parameters</span><span class="p">])</span>

        <span class="c1"># Postition Restraints</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posres</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#ifdef POSRES&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;#ifndef POSRES_FC</span><span class="se">\n</span><span class="s2">#define POSRES_FC </span><span class="si">%.2f</span><span class="se">\n</span><span class="s2">#endif&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosResForce&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; [ position_restraints ]&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;  </span><span class="si">%5d</span><span class="s2">    1    POSRES_FC    POSRES_FC    POSRES_FC&quot;</span> <span class="o">%</span> <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">posres</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#endif&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created coarsegrained topology&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<div class="viewcode-block" id="Topology.fromNucleicAcidSequence">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Topology.fromNucleicAcidSequence">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromNucleicAcidSequence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sequence</span><span class="p">,</span>
        <span class="n">secstruc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">breaks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rubber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Shift for the atom numbers of the atomistic part in a chain</span>
        <span class="c1"># that is being multiscaled</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># First check if we get a sequence or a Chain instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">Chain</span><span class="p">):</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">sequence</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">links</span>
            <span class="n">breaks</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">breaks</span>
            <span class="c1"># If the mapping is not specified, the actual mapping is taken,</span>
            <span class="c1"># used to construct the coarse grained system from the atomistic one.</span>
            <span class="c1"># The function argument &quot;mapping&quot; could be used to use a default</span>
            <span class="c1"># mapping scheme in stead, like the mapping for the GROMOS96 force field.</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span> <span class="ow">or</span> <span class="n">chain</span><span class="o">.</span><span class="n">mapping</span>
            <span class="n">multi</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secstruc</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">sstypes</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;F&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiscale</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secstruc</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>

        <span class="c1"># Fetch the base information</span>
        <span class="c1"># Pad with empty lists for atoms, bonds, angles</span>
        <span class="c1"># and dihedrals, and take the first five lists out</span>
        <span class="c1"># This will avoid errors for residues for which</span>
        <span class="c1"># these are not defined.</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bases</span><span class="p">[</span><span class="n">res</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">[[]])[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
        <span class="p">]</span>

        <span class="c1"># ID of the first atom/residue</span>
        <span class="c1"># The atom number and residue number follow from the last</span>
        <span class="c1"># atom c.q. residue id in the list processed in the topology</span>
        <span class="c1"># thus far. In the case of multiscaling, the real atoms need</span>
        <span class="c1"># also be accounted for.</span>
        <span class="n">startAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">startResi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span>

        <span class="c1"># Backbone bead atom IDs</span>
        <span class="n">bbid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">startAtom</span><span class="p">,</span> <span class="n">startAtom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">startAtom</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sc</span><span class="p">:</span>
            <span class="n">bbid1</span> <span class="o">=</span> <span class="n">bbid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="n">bbid</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bbid1</span><span class="p">,</span> <span class="n">bbid1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bbid1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Residue numbers for this moleculetype topology</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">startResi</span><span class="p">,</span> <span class="n">startResi</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>

        <span class="c1"># This contains the information for deriving backbone bead types,</span>
        <span class="c1"># bb bond types, bbb/bbs angle types, and bbbb dihedral types.</span>
        <span class="n">seqss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bbid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secstruc</span><span class="p">))</span>

        <span class="c1"># Fetch the proper backbone beads</span>
        <span class="c1"># Since there are three beads we need to split these to the list</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bbGetBead</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">seqss</span><span class="p">]</span>
        <span class="n">bbMulti</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bb</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span>

        <span class="c1"># For backbone parameters, iterate over fragments, inferred from breaks</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">breaks</span><span class="p">,</span> <span class="n">breaks</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># Extract the fragment</span>
            <span class="n">frg</span> <span class="o">=</span> <span class="n">seqss</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">seqss</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># Expand the 3 bb beads per residue into one long list</span>
            <span class="c1"># Resulting list contains three tuples per residue</span>
            <span class="c1"># We use the useless ca parameter to get the correct backbone bond from bbGetBond</span>
            <span class="c1"># The i is used to define ca because it conveniently here gives the right sequence 0,1,2,0,1,...</span>
            <span class="n">frg</span> <span class="o">=</span> <span class="p">[(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">frg</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>

            <span class="c1"># Iterate over backbone bonds, two loops are needed because there are multipe cross bonds in the BB.</span>
            <span class="c1"># Since bonded interactions can return None, we first collect them separately and then</span>
            <span class="c1"># add the non-None ones to the list</span>
            <span class="c1"># This part assumes you have a linear backbone (checks only combinations that make sense for such)</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frg</span><span class="p">):</span>

                <span class="c1"># Exclusions iterate over the second atom.</span>
                <span class="c1"># and then checked for each pair.</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">frg</span><span class="p">[</span><span class="n">ind</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]:</span>
                    <span class="c1"># excl = Exclusion((k,l), category=&quot;BB&quot;, options=self.options,)</span>
                    <span class="c1"># if excl:</span>
                    <span class="c1">#     self.exclusions.append(excl)</span>
                    <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">excl</span> <span class="o">=</span> <span class="n">Exclusion</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;BB&quot;</span><span class="p">,</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span>

                <span class="c1"># Pairs iterate over the second atom.</span>
                <span class="c1"># and then checked for each pair.</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">frg</span><span class="p">[</span><span class="n">ind</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]:</span>
                    <span class="n">pair</span> <span class="o">=</span> <span class="n">Pair</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span>
                        <span class="n">category</span><span class="o">=</span><span class="s2">&quot;BB&quot;</span><span class="p">,</span>
                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">pair</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

                <span class="c1"># Bonds iterate over the second atom.</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">frg</span><span class="p">[</span><span class="n">ind</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">bond</span> <span class="o">=</span> <span class="n">Bond</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;BB&quot;</span><span class="p">,</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>

                    <span class="c1"># The angles need a third loop.</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">frg</span><span class="p">[</span><span class="n">ind</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                            <span class="n">angle</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">k</span><span class="p">,</span>
                                    <span class="n">l</span><span class="p">,</span>
                                    <span class="n">m</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                <span class="n">category</span><span class="o">=</span><span class="s2">&quot;BBB&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

                        <span class="c1"># The dihedrals need a fourth loop.</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">frg</span><span class="p">[</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                                <span class="n">dihed</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="n">k</span><span class="p">,</span>
                                        <span class="n">l</span><span class="p">,</span>
                                        <span class="n">m</span><span class="p">,</span>
                                        <span class="n">n</span><span class="p">,</span>
                                    <span class="p">),</span>
                                    <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="s2">&quot;BBBB&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dihed</span><span class="p">)</span>

        <span class="c1"># Now do the atom list, and take the sidechains along</span>
        <span class="c1">#</span>
        <span class="n">atid</span> <span class="o">=</span> <span class="n">startAtom</span>
        <span class="c1"># We need to do some trickery to get all 3 bb beads in to these lists</span>
        <span class="c1"># This adds each element to a list three times, feel free to shorten up</span>
        <span class="n">residMulti</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">resid</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">sequenceMulti</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">scMulti</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sc</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">secstrucMulti</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secstruc</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">resi</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">bbb</span><span class="p">,</span> <span class="n">sidechn</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">residMulti</span><span class="p">,</span> <span class="n">sequenceMulti</span><span class="p">,</span> <span class="n">bbMulti</span><span class="p">,</span> <span class="n">scMulti</span><span class="p">,</span> <span class="n">secstrucMulti</span>
        <span class="p">):</span>
            <span class="c1"># We only want one side chain per three backbone beads so this skips the others</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Note added impropers in contrast to aa</span>
                <span class="p">(</span>
                    <span class="n">scatoms</span><span class="p">,</span>
                    <span class="n">bon_par</span><span class="p">,</span>
                    <span class="n">ang_par</span><span class="p">,</span>
                    <span class="n">dih_par</span><span class="p">,</span>
                    <span class="n">imp_par</span><span class="p">,</span>
                    <span class="n">vsite_par</span><span class="p">,</span>
                    <span class="n">excl_par</span><span class="p">,</span>
                    <span class="n">pair_par</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">sidechn</span>

                <span class="c1"># Side chain bonded terms</span>
                <span class="c1"># Collect bond, angle and dihedral connectivity</span>
                <span class="c1"># Impropers needed to be added here for DNA</span>
                <span class="n">bon_con</span><span class="p">,</span> <span class="n">ang_con</span><span class="p">,</span> <span class="n">dih_con</span><span class="p">,</span> <span class="n">imp_con</span><span class="p">,</span> <span class="n">vsite_con</span><span class="p">,</span> <span class="n">excl_con</span><span class="p">,</span> <span class="n">pair_con</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">base_connectivity</span><span class="p">[</span><span class="n">resname</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">[[]]</span>
                <span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
                <span class="c1"># Ill try to fix the exclusions by using separate connectivity record for DNA</span>
                <span class="c1"># bon_con,ang_con,dih_con,imp_con,vsite_con = (self.options[&#39;ForceField&#39;].connectivity[resname]+5*[[]])[:5]</span>

                <span class="c1"># Side Chain Bonds/Constraints</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bon_con</span><span class="p">,</span> <span class="n">bon_par</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100000.00000</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">Bond</span><span class="p">(</span>
                                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span>
                                <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                <span class="nb">type</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">comments</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                                <span class="n">category</span><span class="o">=</span><span class="s2">&quot;Constraint&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bond</span> <span class="o">=</span> <span class="n">Bond</span><span class="p">(</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                            <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">comments</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;SC&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
                    <span class="c1"># Shift the atom numbers</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>

                <span class="c1"># Side Chain Angles</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ang_con</span><span class="p">,</span> <span class="n">ang_par</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Angle</span><span class="p">(</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                            <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">comments</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;SC&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># Shift the atom numbers</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>

                <span class="c1"># Side Chain Dihedrals</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dih_con</span><span class="p">,</span> <span class="n">dih_par</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Dihedral</span><span class="p">(</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                            <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">comments</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;BSC&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># Shift the atom numbers</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>

                <span class="c1"># Side Chain Impropers</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imp_con</span><span class="p">,</span> <span class="n">imp_par</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Dihedral</span><span class="p">(</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                            <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">comments</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;SC&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># Shift the atom numbers</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>

                <span class="c1"># Side Chain V-Sites</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vsite_con</span><span class="p">,</span> <span class="n">vsite_par</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Vsite</span><span class="p">(</span>
                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                            <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="n">par</span><span class="p">,</span>
                            <span class="n">comments</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;SC&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>  <span class="c1"># Shift the atom numbers</span>

                <span class="c1"># Side Chain Exclusions</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">excl_con</span><span class="p">,</span> <span class="n">excl_par</span><span class="p">):</span>
                    <span class="n">exclusion</span> <span class="o">=</span> <span class="n">Exclusion</span><span class="p">(</span>
                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;SC&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exclusion</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>  <span class="c1"># Shift the atom numbers</span>

                <span class="c1"># Pairs</span>
                <span class="k">for</span> <span class="n">atids</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pair_con</span><span class="p">,</span> <span class="n">pair_par</span><span class="p">):</span>
                    <span class="n">pair</span> <span class="o">=</span> <span class="n">Pair</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atids</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">atid</span>  <span class="c1"># Shift the atom numbers</span>

                <span class="c1"># All residue atoms</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counts over beads</span>
                <span class="c1"># Need to tweak this to get all the backbone beads to the list with the side chain</span>
                <span class="n">bbbset</span> <span class="o">=</span> <span class="p">[</span><span class="n">bbMulti</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">bbMulti</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bbMulti</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">atype</span><span class="p">,</span> <span class="n">aname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">bbbset</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">scatoms</span><span class="p">),</span> <span class="n">CoarseGrained</span><span class="o">.</span><span class="n">residue_bead_names_dna</span>
                <span class="p">):</span>
                    <span class="c1"># self.atoms.append((atid,atype,resi,resname,aname,atid,self.options[&#39;ForceField&#39;].getCharge(atype,aname),ss))</span>
                    <span class="k">if</span> <span class="n">atid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vSite</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">vSite</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">]:</span>
                        <span class="n">charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getCharge</span><span class="p">(</span><span class="n">atype</span><span class="p">,</span> <span class="n">aname</span><span class="p">)</span>
                        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">atid</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getCharge</span><span class="p">(</span><span class="n">atype</span><span class="p">,</span> <span class="n">aname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB1&quot;</span><span class="p">:</span>
                            <span class="n">mass</span> <span class="o">=</span> <span class="mi">72</span>
                        <span class="k">elif</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB2&quot;</span> <span class="ow">or</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB3&quot;</span><span class="p">:</span>
                            <span class="n">mass</span> <span class="o">=</span> <span class="mi">60</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mass</span> <span class="o">=</span> <span class="mi">36</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">atid</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="c1"># Doing this here saves going over all the atoms onesmore.</span>
                    <span class="c1"># Generate position restraints for all atoms or Backbone beads only. @POSRES</span>
                    <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB1&quot;</span>
                            <span class="ow">or</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB2&quot;</span>
                            <span class="ow">or</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB3&quot;</span>
                            <span class="ow">or</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;SC1&quot;</span>
                        <span class="p">)</span> <span class="ow">and</span> <span class="n">atid</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">posres</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s2">&quot;bb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;PosRes&quot;</span><span class="p">]:</span>  <span class="c1"># @POSRES</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;BB2&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">atid</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">posres</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">mapping</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">atid</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">shift</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">counter</span><span class="p">]])</span>
                        <span class="p">)</span>
                    <span class="n">atid</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># One more thing, we need to remove dihedrals (2) and an angle (1)  that reach beyond the 3&#39; end</span>
        <span class="c1"># This is stupid to do now but the total number of atoms seems not to be available before</span>
        <span class="c1"># This iterate the list in reverse order so that removals don&#39;t affect later checks</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># The first residue of DNA (The 5&#39; end) has a backbone that is only two beads. This is ugly</span>
        <span class="c1"># but we&#39;ll save our headache of changing the whole internal logic.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>

        <span class="c1"># Remove the first bead and shift the numbers of all others by one.</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="p">)</span>
        <span class="n">enStrandLengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Remove the last posres, faster than removing first and shifting all.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">posres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># The rubber bands are best applied outside of the chain class, as that gives</span>
        <span class="c1"># more control when chains need to be merged. The possibility to do it on the</span>
        <span class="c1"># chain level is retained to allow building a complete chain topology in</span>
        <span class="c1"># a straightforward manner after importing this script as module.</span>
        <span class="k">if</span> <span class="n">rubber</span> <span class="ow">and</span> <span class="n">chain</span><span class="p">:</span>
            <span class="n">rubberList</span> <span class="o">=</span> <span class="n">rubberBands</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">cg</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ElasticBeads</span>
                <span class="p">],</span>
                <span class="n">ElasticLowerBound</span><span class="p">,</span>
                <span class="n">ElasticUpperBound</span><span class="p">,</span>
                <span class="n">ElasticDecayFactor</span><span class="p">,</span>
                <span class="n">ElasticDecayPower</span><span class="p">,</span>
                <span class="n">ElasticMaximumForce</span><span class="p">,</span>
                <span class="n">ElasticMinimumForce</span><span class="p">,</span>
            <span class="p">)</span></div>

            <span class="c1"># self.bonds.extend([Bond(i,options=self.options,type=6,category=&quot;Rubber band&quot;) for i in rubberList])</span>

<div class="viewcode-block" id="Topology.fromMoleculeList">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.Topology.fromMoleculeList">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromMoleculeList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>



<span class="c1">#############</span>
<span class="c1">## 8 # MAIN #  -&gt; @MAIN &lt;-</span>
<span class="c1">#############</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">logging</span><span class="o">,</span><span class="w"> </span><span class="nn">random</span><span class="o">,</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../reforge.martini.html#reforge.martini.martinize_nucleotides.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="c1"># Check whether to read from a gro/pdb file or from stdin</span>
    <span class="c1"># We use an iterator to wrap around the stream to allow</span>
    <span class="c1"># inferring the file type, without consuming lines already</span>
    <span class="n">inStream</span> <span class="o">=</span> <span class="n">streamTag</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-f&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-f&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
    <span class="n">fileType</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">inStream</span><span class="p">)</span>
    <span class="n">frameIterator</span> <span class="o">=</span> <span class="n">pdbFrameIterator</span>

    <span class="c1">## ITERATE OVER FRAMES IN STRUCTURE FILE ##</span>

    <span class="c1"># Now iterate over the frames in the stream</span>
    <span class="c1"># This should become a StructureFile class with a nice .next method</span>
    <span class="n">model</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cgOutPDB</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ssTotal</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cysteines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">frameIterator</span><span class="p">(</span><span class="n">inStream</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s2">&quot;PDB&quot;</span><span class="p">:</span>
            <span class="c1"># The PDB file can have chains, in which case we list and process them specifically</span>
            <span class="c1"># TER statements are also interpreted as chain separators</span>
            <span class="c1"># A chain may have breaks in which case the breaking residues are flagged</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Chain</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">(</span><span class="n">chain</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">pdbChains</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="c1"># Check the chain identifiers</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">_id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">])):</span>
            <span class="c1"># Ending down here means that non-consecutive blocks of atoms in the</span>
            <span class="c1"># PDB file have the same chain ID. The warning pertains to PDB files only,</span>
            <span class="c1"># since chains from GRO files get a unique chain identifier assigned.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Several chains have identical chain identifiers in the PDB file.&quot;</span>
            <span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> chains:&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;  </span><span class="si">%2d</span><span class="s2">:   </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">), </span><span class="si">%d</span><span class="s2"> atoms in </span><span class="si">%d</span><span class="s2"> residues.&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Check which chains need merging</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">order</span><span class="p">,</span> <span class="n">merge</span> <span class="o">=</span> <span class="n">check_merge</span><span class="p">(</span>
                <span class="n">chains</span><span class="p">,</span>
                <span class="n">options</span><span class="p">[</span><span class="s2">&quot;mergeList&quot;</span><span class="p">],</span>
                <span class="n">options</span><span class="p">[</span><span class="s2">&quot;linkList&quot;</span><span class="p">],</span>
                <span class="n">options</span><span class="p">[</span><span class="s2">&quot;CystineCheckBonds&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;CystineMaxDist2&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Get the total length of the sequence</span>
        <span class="n">seqlength</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total size of the system: </span><span class="si">%s</span><span class="s2"> residues.&quot;</span> <span class="o">%</span> <span class="n">seqlength</span><span class="p">)</span>

        <span class="c1">## SECONDARY STRUCTURE</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;Collagen&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
                <span class="n">chain</span><span class="o">.</span><span class="n">set_ss</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="n">ss</span> <span class="o">+=</span> <span class="n">chain</span><span class="o">.</span><span class="n">ss</span>
            <span class="c1"># Now set the secondary structure for each of the chains</span>
            <span class="n">sstmp</span> <span class="o">=</span> <span class="n">ss</span>
            <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
                <span class="n">ln</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sstmp</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">))</span>
                <span class="n">chain</span><span class="o">.</span><span class="n">set_ss</span><span class="p">(</span><span class="n">sstmp</span><span class="p">[:</span><span class="n">ln</span><span class="p">])</span>
                <span class="n">sstmp</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[:</span><span class="n">ln</span><span class="p">]</span>
        <span class="c1"># Collect the secondary structure classifications for different frames</span>
        <span class="n">ssTotal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>

        <span class="c1"># Write the coarse grained structure if requested</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing coarse grained structure.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cgOutPDB</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cgOutPDB</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">cgOutPDB</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MODEL </span><span class="si">%8d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">cgOutPDB</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">cgOutPDB</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pdbBoxString</span><span class="p">(</span><span class="n">box</span><span class="p">))</span>
            <span class="n">atid</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">write_start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">coarseGrained</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">cg</span><span class="p">(</span><span class="n">com</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">coarseGrained</span><span class="p">:</span>
                    <span class="c1"># For DNA we need to remove the first bead on the 5&#39; end and shift the atids.</span>
                    <span class="k">if</span> <span class="n">ci</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Nucleic&quot;</span><span class="p">:</span>
                        <span class="n">write_start</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">write_start</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">resn</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ssid</span> <span class="ow">in</span> <span class="n">coarseGrained</span><span class="p">[</span>
                        <span class="n">write_start</span><span class="p">:</span>
                    <span class="p">]:</span>
                        <span class="n">insc</span> <span class="o">=</span> <span class="n">resi</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span>
                        <span class="n">resi</span> <span class="o">-=</span> <span class="n">insc</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span>
                        <span class="n">cgOutPDB</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="n">pdbAtomLine</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="n">atid</span><span class="p">,</span>
                                <span class="n">name</span><span class="p">,</span>
                                <span class="n">resn</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span>
                                <span class="n">chain</span><span class="p">,</span>
                                <span class="n">resi</span><span class="p">,</span>
                                <span class="nb">chr</span><span class="p">(</span><span class="n">insc</span><span class="p">),</span>
                                <span class="n">x</span><span class="p">,</span>
                                <span class="n">y</span><span class="p">,</span>
                                <span class="n">z</span><span class="p">,</span>
                                <span class="mi">1</span><span class="p">,</span>
                                <span class="n">ssid</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">atid</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cgOutPDB</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;TER</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;No mapping for coarse graining chain </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">); chain is skipped.&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">ci</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>
                    <span class="p">)</span>
            <span class="n">cgOutPDB</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ENDMDL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Gather cysteine sulphur coordinates</span>
        <span class="n">cyslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cys</span><span class="p">[</span><span class="s2">&quot;SG&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">for</span> <span class="n">cys</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">[</span><span class="s2">&quot;CYS&quot;</span><span class="p">]]</span>
        <span class="n">cysteines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cys</span> <span class="k">for</span> <span class="n">cys</span> <span class="ow">in</span> <span class="n">cyslist</span> <span class="k">if</span> <span class="n">cys</span><span class="p">])</span>
        <span class="n">model</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Evertything below here we only need, if we need to write a Topology</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-o&quot;</span><span class="p">]:</span>
        <span class="c1"># Collect the secondary structure stuff and decide what to do with it</span>
        <span class="c1"># First rearrange by the residue</span>
        <span class="n">ssTotal</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ssTotal</span><span class="p">)</span>
        <span class="n">ssAver</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ssTotal</span><span class="p">:</span>
            <span class="n">si</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Only one type -- consensus</span>
                <span class="n">ssAver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Transitions between secondary structure types</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">si</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                <span class="n">si</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">si</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-ssc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">ssAver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ssAver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="n">ssAver</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ssAver</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;(Average) Secondary structure has been determined (see head of .itp-file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Divide the secondary structure according to the division in chains</span>
        <span class="c1"># This will set the secondary structure types to be used for the</span>
        <span class="c1"># topology.</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="n">chain</span><span class="o">.</span><span class="n">set_ss</span><span class="p">(</span><span class="n">ssAver</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)])</span>
            <span class="n">ssAver</span> <span class="o">=</span> <span class="n">ssAver</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="p">:]</span>

        <span class="c1"># Now the chains are complete, each consisting of a residuelist,</span>
        <span class="c1"># and a secondary structure designation if the chain is of type &#39;Protein&#39;.</span>
        <span class="c1"># There may be mixed chains, there may be HETATM things.</span>
        <span class="c1"># Water has been discarded. Maybe this has to be changed at some point.</span>
        <span class="c1"># The order in the coarse grained files matches the order in the set of chains.</span>
        <span class="c1">#</span>
        <span class="c1"># If there are no merges to be done, i.e. no global Elnedyn network, no</span>
        <span class="c1"># disulphide bridges, no links, no distance restraints and no explicit merges,</span>
        <span class="c1"># then we can write out the topology, which will match the coarse grained file.</span>
        <span class="c1">#</span>
        <span class="c1"># If there are merges to be done, the order of things may be changed, in which</span>
        <span class="c1"># case the coarse grained structure will not match with the topology...</span>

        <span class="c1">## REAL ITP STUFF ##</span>
        <span class="c1"># Check whether we have identical chains, in which case we</span>
        <span class="c1"># only write the ITP for one...</span>
        <span class="c1"># This means making a distinction between chains and</span>
        <span class="c1"># moleculetypes.</span>

        <span class="n">molecules</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">merge</span><span class="p">]</span>

        <span class="c1"># At this point we should have a list or dictionary of chains</span>
        <span class="c1"># Each chain should be given a unique name, based on the value</span>
        <span class="c1"># of options[&quot;-o&quot;] combined with the chain identifier and possibly</span>
        <span class="c1"># a number if there are chains with identical identifiers.</span>
        <span class="c1"># For each chain we then write an ITP file using the name for</span>
        <span class="c1"># moleculetype and name + &quot;.itp&quot; for the topology include file.</span>
        <span class="c1"># In addition we write a master topology file, using the value of</span>
        <span class="c1"># options[&quot;-o&quot;], with an added extension &quot;.top&quot; if not given.</span>

        <span class="c1"># XXX *NOTE*: This should probably be gathered in a &#39;Universe&#39; class</span>
        <span class="n">itp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">moleculeTypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cumulative_atoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">mi</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">molecules</span><span class="p">):</span>
            <span class="c1"># Check if the moleculetype is already listed</span>
            <span class="c1"># If not, generate the topology from the chain definition</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">moleculeTypes</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;SeparateTop&quot;</span><span class="p">]:</span>
                <span class="c1"># Name of the moleculetype</span>
                <span class="c1"># NOTE: The naming should be changed; now it becomes Protein_X+Protein_Y+...</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">chain</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;-name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">mol</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">moleculeTypes</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="c1"># Write the molecule type topology</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">Topology</span><span class="p">(</span><span class="n">mol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># This merges topologies, properties how adding happens in Topology method __iadd__</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mol</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">top</span> <span class="o">+=</span> <span class="n">Topology</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

                <span class="c1"># Have to add the connections, like the connecting network</span>
                <span class="c1"># Gather coordinates</span>
                <span class="n">mcg</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[(</span><span class="n">j</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mol</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">cg</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="n">mcg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mcg</span><span class="p">)</span>

                <span class="c1"># Elastic Network</span>
                <span class="c1"># The elastic network is added after the topology is constructed, since that</span>
                <span class="c1"># is where the correct atom list with numbering and the full set of</span>
                <span class="c1"># coordinates for the merged chains are available.</span>
                <span class="c1"># For Nucleic have to watch out for the missing first bead again.</span>
                <span class="c1"># THIS IS BANDAID FOR NOW, ONLY WORKS FOR TWO CHAINS</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Nucleic&quot;</span><span class="p">:</span>
                    <span class="n">strands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enStrandLengths</span><span class="p">)</span>
                    <span class="n">cuts</span> <span class="o">=</span> <span class="p">[</span><span class="n">enStrandLengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">nucleic_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">strands</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">strands</span><span class="p">):</span>
                            <span class="n">cuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">enStrandLengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">strands</span><span class="p">):</span>
                            <span class="n">nucleic_coords</span> <span class="o">+=</span> <span class="n">coords</span><span class="p">[</span><span class="n">cuts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">cuts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticNetwork&quot;</span><span class="p">]:</span>
                        <span class="n">rubberType</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">EBondType</span>
                        <span class="n">rubberList</span> <span class="o">=</span> <span class="n">rubberBands</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">nucleic_coords</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticBeads&quot;</span><span class="p">]</span>
                            <span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticLowerBound&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticUpperBound&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticDecayFactor&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticDecayPower&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMaximumForce&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMinimumForce&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">top</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">Bond</span><span class="p">(</span>
                                    <span class="n">i</span><span class="p">,</span>
                                    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                                    <span class="nb">type</span><span class="o">=</span><span class="n">rubberType</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="s2">&quot;Rubber band&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rubberList</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticNetwork&quot;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticBeads&quot;</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">rubberType</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ForceField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">EBondType</span>
                        <span class="n">rubberList</span> <span class="o">=</span> <span class="n">rubberBands</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticBeads&quot;</span><span class="p">]</span>
                            <span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticLowerBound&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticUpperBound&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticDecayFactor&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticDecayPower&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMaximumForce&quot;</span><span class="p">],</span>
                            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ElasticMinimumForce&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">top</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">Bond</span><span class="p">(</span>
                                    <span class="n">i</span><span class="p">,</span>
                                    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                                    <span class="nb">type</span><span class="o">=</span><span class="n">rubberType</span><span class="p">,</span>
                                    <span class="n">category</span><span class="o">=</span><span class="s2">&quot;Rubber band&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rubberList</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

                <span class="c1"># Write out the MoleculeType topology</span>
                <span class="n">destination</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;-o&quot;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="nb">open</span><span class="p">(</span><span class="n">moleculeTypes</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.itp&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
                <span class="p">)</span>
                <span class="n">destination</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">top</span><span class="p">))</span>

                <span class="n">itp</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Check whether other chains are equal to this one</span>
            <span class="c1"># Skip this step if we are to write all chains to separate moleculetypes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;SeparateTop&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">molecules</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">moleculeTypes</span> <span class="ow">and</span> <span class="n">mol</span> <span class="o">==</span> <span class="n">molecules</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="c1"># Molecule j is equal to a molecule mi</span>
                        <span class="c1"># Set the name of the moleculetype to the one of that molecule</span>
                        <span class="n">moleculeTypes</span><span class="p">[</span><span class="n">molecules</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">moleculeTypes</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span>

            <span class="c1"># For the parameterization index files we need to update the cumulative number of atoms.</span>
            <span class="c1"># For parameterization option SepareteTop should always be used because otherwise the numbering will fail.</span>
            <span class="n">cumulative_atoms</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Written </span><span class="si">%d</span><span class="s2"> ITP file</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">itp</span><span class="p">,</span> <span class="n">itp</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;s&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

    <span class="c1"># The following lines are always printed (if no errors occur).</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">There you are. One MARTINI. Shaken, not stirred.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">martiniq</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">martiniq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%80s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">lists</span> <span class="o">=</span> <span class="n">options</span><span class="p">,</span> <span class="n">lists</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">option_parser</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">lists</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Danis Yangaliev.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>